<!DOCTYPE html>
<html lang="cn">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="sweetboyZhang">
  <meta name="keywords" content="">
  <title>书城项目 - sweetboyZhang&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/vs.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>sweetboyZhang's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                archive
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                tag
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                about
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-04-08 17:51">
      April 8, 2020 pm
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      16.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      351
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p class="note note-info">
                
                  本文最后更新于：July 15, 2020 pm
                
              </p>
            
            <article class="markdown-body">
              <h2 id="一、创建项目所需要的包"><a href="#一、创建项目所需要的包" class="headerlink" title="一、创建项目所需要的包"></a>一、创建项目所需要的包</h2><p>各个层所对应的包名：<a id="more"></a><br>web层：<br>com.bookmall.web/servlet/controller<br>service层：<br>com.bookmall.service&nbsp;&nbsp;&nbsp;Service接口包<br>com.bookmall.service.impl&nbsp;&nbsp;&nbsp;Service接口实现类<br>dao层：<br>com.bookmall.dao&nbsp;&nbsp;&nbsp;Dao接口包<br>com.bookmall.dao.impl&nbsp;&nbsp;&nbsp;Dao接口实现类<br>实体bean对象：<br>com.bookmall.pojo/entity/domain/bean&nbsp;&nbsp;&nbsp;JavaBean类<br>测试包：<br>com.bookmall.test/junit<br>工具包：<br>com.bookmall.utils<br><img src="/2020/04/08/javaweb-02/1.png" srcset="/img/loading.gif" alt></p>
<h2 id="二、创建需要的数据库和表"><a href="#二、创建需要的数据库和表" class="headerlink" title="二、创建需要的数据库和表"></a>二、创建需要的数据库和表</h2><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> bookmall;

<span class="hljs-keyword">USE</span> bookmall;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> userinfo(
	 <span class="hljs-string">`id`</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> auto_increment,
	 <span class="hljs-string">`username`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	 <span class="hljs-string">`password`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`email`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>)
);

<span class="hljs-keyword">INSERT</span>  <span class="hljs-keyword">INTO</span> userinfo(<span class="hljs-string">`username`</span>,<span class="hljs-string">`password`</span>,<span class="hljs-string">`email`</span>)

<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'admin'</span>,<span class="hljs-string">'123456'</span>,<span class="hljs-string">'admin@qq.com'</span>);

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> userinfo;</code></pre>

<h2 id="三、编写数据库表对应的-JavaBean-对象"><a href="#三、编写数据库表对应的-JavaBean-对象" class="headerlink" title="三、编写数据库表对应的 JavaBean 对象"></a>三、编写数据库表对应的 JavaBean 对象</h2><p>在com.bookmall.bean包下创建User类</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.bean;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(Integer id, String username, String password, String email)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.username = username;
        <span class="hljs-keyword">this</span>.password = password;
        <span class="hljs-keyword">this</span>.email = email;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> username;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.username = username;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> password;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.password = password;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> email;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEmail</span><span class="hljs-params">(String email)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.email = email;
    &#125;
    
     <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User&#123;"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", username='"</span> + username + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", password='"</span> + password + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", email='"</span> + email + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<h2 id="四、编写工具类JdbcUtils并测试"><a href="#四、编写工具类JdbcUtils并测试" class="headerlink" title="四、编写工具类JdbcUtils并测试"></a>四、编写工具类JdbcUtils并测试</h2><p>1.首先导入所需要的jar包：<br><img src="/2020/04/08/javaweb-02/2.png" srcset="/img/loading.gif" alt></p>
<p>2.在src目录下创建jdbc.properties 配置文件：</p>
<pre><code class="hljs properties"><span class="hljs-attr">username</span>=<span class="hljs-string">root</span>
<span class="hljs-attr">password</span>=<span class="hljs-string">2824199842</span>
<span class="hljs-attr">url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/bookmall?serverTimezone=Asia/Shanghai</span>
<span class="hljs-attr">driverClassName</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
<span class="hljs-attr">initialSize</span>=<span class="hljs-string">10</span>
<span class="hljs-attr">maxActive</span>=<span class="hljs-string">10</span></code></pre>

<p>3.在com.bookmall.utils下创建 JdbcUtils 类：</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.utils;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JdbcUtils</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidDataSource dataSource;
    <span class="hljs-keyword">static</span>&#123;
        Properties properties = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            properties = <span class="hljs-keyword">new</span> Properties();
            <span class="hljs-comment">// 创建输入流 读取jdbc.properties属性配置文件</span>
            InputStream inputStream = JdbcUtils.class.getClassLoader().getResourceAsStream("jdbc.properties");
            <span class="hljs-comment">// 从流中加载数据</span>
            properties.load(inputStream);
            <span class="hljs-comment">// 创建数据库连接池</span>
            dataSource = (DruidDataSource) DruidDataSourceFactory.createDataSource(properties);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 获取数据库连接池中的连接</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回连接  否则返回null</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection</span><span class="hljs-params">()</span></span>&#123;
        Connection conn = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            conn = dataSource.getConnection();
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> conn;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 关闭连接，放回数据库连接池</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> conn</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">(Connection conn)</span></span>&#123;
        <span class="hljs-keyword">if</span>(conn!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">try</span> &#123;
                conn.close();
            &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

<p>4.在com.bookmall.test包下创建JdbcUtilsTest类，测试是否连接成功：</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.test;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JdbcUtilsTest</span> </span>&#123;
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testJdbcUtils</span><span class="hljs-params">()</span> </span>&#123;
        Connection conn = JdbcUtils.getConnection();
        System.out.println(conn);
        JdbcUtils.close(conn);
    &#125;
&#125;</code></pre>

<h2 id="五、编写BaseDao"><a href="#五、编写BaseDao" class="headerlink" title="五、编写BaseDao"></a>五、编写BaseDao</h2><p>1.导入DBUtils 的jar包：<br><img src="/2020/04/08/javaweb-02/4.png" srcset="/img/loading.gif" alt></p>
<p>2.在com.bookmall.dao.impl包下创建BaseDao抽象类：</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.dao.impl;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseDao</span> </span>&#123;
    <span class="hljs-comment">// 使用dbutils操作数据库</span>
    <span class="hljs-keyword">private</span> QueryRunner queryRunner = <span class="hljs-keyword">new</span> QueryRunner();

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 执行增删改方法</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sql 要执行的sql语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 要填充的占位符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回受影响的行数，否则执行失败，返回-1</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(String sql,Object ... args)</span></span>&#123;
        Connection conn = JdbcUtils.getConnection();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">return</span> queryRunner.update(conn,sql,args);
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;<span class="hljs-keyword">finally</span> &#123;
            JdbcUtils.close(conn);
        &#125;
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 执行返回一条结果的查询语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type 返回的对象类型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sql 要执行的sql语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 要填充的占位符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt; 返回的类型的泛型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回一个指定类型的对象，否则执行失败，返回null</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">queryForOne</span><span class="hljs-params">(Class&lt;T&gt; type,String sql,Object ... args)</span></span>&#123;
        Connection conn = JdbcUtils.getConnection();
        <span class="hljs-comment">// BeanHandler是ResultSetHandler接口的一个实现类，用于封装表中的一条记录</span>
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">return</span> queryRunner.query(conn,sql,<span class="hljs-keyword">new</span> BeanHandler&lt;T&gt;(type),args);
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;<span class="hljs-keyword">finally</span> &#123;
            JdbcUtils.close(conn);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 执行返回多条结果的查询语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type 返回的对象类型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sql 要执行的sql语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 要填充的占位符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt; 返回的类型的泛型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回一个指定类型的对象的列表，否则执行失败，返回null</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">List&lt;T&gt; <span class="hljs-title">queryForList</span><span class="hljs-params">(Class&lt;T&gt; type, String sql, Object ... args)</span></span>&#123;
        Connection conn = JdbcUtils.getConnection();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">return</span> queryRunner.query(conn,sql,<span class="hljs-keyword">new</span> BeanListHandler&lt;T&gt;(type),args);
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;<span class="hljs-keyword">finally</span> &#123;
            JdbcUtils.close(conn);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 执行返回特殊值（一行一列）的查询</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sql 要执行的sql语句</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 要填充的占位符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回一个值，否则执行失败，返回null</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">queryForSingleValue</span><span class="hljs-params">(String sql, Object ... args)</span></span>&#123;
        Connection conn = JdbcUtils.getConnection();
        <span class="hljs-comment">// ScalarHandler将单个值封装</span>
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">return</span> queryRunner.query(conn,sql,<span class="hljs-keyword">new</span> ScalarHandler(),args);
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;<span class="hljs-keyword">finally</span>&#123;
            JdbcUtils.close(conn);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
&#125;</code></pre>

<h2 id="六、编写UserDao接口并测试"><a href="#六、编写UserDao接口并测试" class="headerlink" title="六、编写UserDao接口并测试"></a>六、编写UserDao接口并测试</h2><p>1.在com.bookmall.dao包下编写UserDao 接口</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.dao;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDao</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据用户名查询用户信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username 用户名</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回User对象，否则返回null</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryUserByUsername</span><span class="hljs-params">(String username)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 保存用户信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user User对象</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功，返回受影响的行数，否则返回-1</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveUser</span><span class="hljs-params">(User user)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     *根据用户名和密码查询用户信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> password</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 执行成功返回User对象，否则返回null说明用户名或密码错误</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryUserByUsernameAndPassword</span><span class="hljs-params">(String username,String password)</span></span>;
&#125;</code></pre>

<p>2.在com.bookmall.dao包下编写UserDao接口实现类UserDaoImpl</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.book.dao.impl;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDao</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryUserByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;
        String sql = <span class="hljs-string">"select `id`,`username`,`password`,`email` from userinfo where username = ?"</span>;
        <span class="hljs-keyword">return</span> queryForOne(User<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">sql</span>, <span class="hljs-title">username</span>)</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveUser</span><span class="hljs-params">(User user)</span> </span>&#123;
        String sql = <span class="hljs-string">"insert into userinfo(`username`,`password`,`email`)value(?,?,?)"</span>;
        <span class="hljs-keyword">return</span> update(sql, user.getUsername(), user.getPassword(), user.getEmail());
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryUserByUsernameAndPassword</span><span class="hljs-params">(String username, String password)</span> </span>&#123;
        String sql = <span class="hljs-string">"select `id`,`username`,`password`,`email` from userInfo where username = ? and password = ?"</span>;
        <span class="hljs-keyword">return</span> queryForOne(User<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">sql</span>, <span class="hljs-title">username</span>, <span class="hljs-title">password</span>)</span>;
    &#125;
&#125;</code></pre>

<p>3.在com.bookmall.test包下创建UserDaoImplTest测试类(UserDaoImpl类下按ctrl+shift+t快速创建测试类)，测试UserDaoImpl类中的方法。</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.test;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDaoImplTest</span> </span>&#123;
    UserDao userDao = <span class="hljs-keyword">new</span> UserDaoImpl();
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryUserByUsername</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">if</span>(userDao.queryUserByUsername(<span class="hljs-string">"admin"</span>)!=<span class="hljs-keyword">null</span>)&#123;
            System.out.println(<span class="hljs-string">"用户名可用"</span>);
        &#125;<span class="hljs-keyword">else</span>&#123;
        System.out.println(<span class="hljs-string">"用户名已存在"</span>);
        &#125;
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveUser</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(userDao.saveUser(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,<span class="hljs-string">"大司马"</span>,<span class="hljs-string">"123456"</span>,<span class="hljs-string">"dsm@qq.com"</span>)));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryUserByUsernameAndPassword</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">if</span>(userDao.queryUserByUsernameAndPassword(<span class="hljs-string">"admin"</span>,<span class="hljs-string">"123456"</span>) == <span class="hljs-keyword">null</span>)&#123;
            System.out.println(<span class="hljs-string">"用户名或密码错误，登录失败！"</span>);
        &#125;<span class="hljs-keyword">else</span>&#123;
        System.out.println(<span class="hljs-string">"登录成功！"</span>);
        &#125;
    &#125;
&#125;</code></pre>

<h2 id="七、编写UserService并测试"><a href="#七、编写UserService并测试" class="headerlink" title="七、编写UserService并测试"></a>七、编写UserService并测试</h2><p>1.在com.bookmall.service包下创建UserService接口</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.service;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户注册</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registUser</span><span class="hljs-params">(User user)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户登录</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> user</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">login</span><span class="hljs-params">(User user)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 检查用户名是否可用</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回true，表示用户已存在，否则返回false</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">existUsername</span><span class="hljs-params">(String username)</span></span>;
&#125;</code></pre>

<p>2.在com.bookmall.service.impl创建UserService接口实现类UserServiceImpl</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.service.impl;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserDao userDao = <span class="hljs-keyword">new</span> UserDaoImpl();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registUser</span><span class="hljs-params">(User user)</span> </span>&#123;
        userDao.saveUser(user);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">login</span><span class="hljs-params">(User user)</span> </span>&#123;
        <span class="hljs-keyword">return</span> userDao.queryUserByUsernameAndPassword(user.getUsername(),user.getPassword());
    &#125;


    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">existUsername</span><span class="hljs-params">(String username)</span> </span>&#123;
        <span class="hljs-keyword">if</span>(userDao.queryUserByUsername(username)==<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 为null表示不存在，表示可以使用</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;
&#125;</code></pre>

<p>3.在com.bookmall.test包下创建测试类UserServiceImplTest，测试UserServiceImpl中的方法</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.test;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImplTest</span> </span>&#123;
    UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registUser</span><span class="hljs-params">()</span> </span>&#123;
        userService.registUser(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,<span class="hljs-string">"张伟"</span>,<span class="hljs-string">"123456"</span>,<span class="hljs-string">"zw@126.com"</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">login</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(userService.login(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,<span class="hljs-string">"zyz"</span>,<span class="hljs-string">"123456"</span>,<span class="hljs-keyword">null</span>)));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">existUsername</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(userService.existUsername(<span class="hljs-string">"zyz"</span>));<span class="hljs-comment">// ture</span>

    &#125;
&#125;</code></pre>

<h2 id="八、编写Web层"><a href="#八、编写Web层" class="headerlink" title="八、编写Web层"></a>八、编写Web层</h2><h3 id="1-实现注册功能"><a href="#1-实现注册功能" class="headerlink" title="1.实现注册功能"></a>1.实现注册功能</h3><p>在com.bookmall.web中创建RegistServlet类<br>在web.xml文件中配置文件路径</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>RegistServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.bookmall.web.RegistServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>RegistServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/registServlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span></code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.web;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegistServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        String email = req.getParameter(<span class="hljs-string">"email"</span>);
        String code = req.getParameter(<span class="hljs-string">"code"</span>);
        <span class="hljs-comment">// 2.检查验证码是否正确====先写死为qwer</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-string">"qwer"</span>.equalsIgnoreCase(code))&#123;
            <span class="hljs-comment">// 验证码正确</span>
            <span class="hljs-comment">// 3.检查用户名是否可用</span>
            <span class="hljs-keyword">if</span>(userService.existUsername(username))&#123;
                <span class="hljs-comment">// true 用户名已存在</span>
                System.out.println(<span class="hljs-string">"用户名["</span>+username+<span class="hljs-string">"]已存在！"</span>);
                <span class="hljs-comment">// 跳转到首页</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.html"</span>).forward(req,resp);
            &#125; <span class="hljs-keyword">else</span>&#123;
                <span class="hljs-comment">// false 用户名不存在  可以注册</span>
                userService.registUser(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,username,password,email));
                <span class="hljs-comment">// 跳转到注册成功页面</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist_success.html"</span>).forward(req,resp);
            &#125;
        &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">// 验证码错误</span>
            System.out.println(<span class="hljs-string">"验证码["</span>+code+<span class="hljs-string">"]错误！"</span>);
            <span class="hljs-comment">// 跳转到首页</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.html"</span>).forward(req,resp);
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="2-实现登录功能"><a href="#2-实现登录功能" class="headerlink" title="2.实现登录功能"></a>2.实现登录功能</h3><p>在com.bookmall.web中创建LogintServlet类<br>在web.xml文件中配置文件路径</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>LoginServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.bookmall.web.LoginServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>LoginServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/loginServlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span></code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.web;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        User loginUser = userService.login(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,username, password, <span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">if</span>(loginUser==<span class="hljs-keyword">null</span>)&#123;
                System.out.println(<span class="hljs-string">"登录失败！"</span>);
                <span class="hljs-comment">// 跳转到首页</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login.html"</span>).forward(req,resp);
        &#125;<span class="hljs-keyword">else</span>&#123;
            System.out.println(<span class="hljs-string">"登录成功！"</span>);
                <span class="hljs-comment">// 跳转到登录成功页面</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login_success.html"</span>).forward(req,resp);
        &#125;
    &#125;
&#125;</code></pre>

<h2 id="九、优化代码"><a href="#九、优化代码" class="headerlink" title="九、优化代码"></a>九、优化代码</h2><h3 id="1-将多个页面中重复的代码抽取出来："><a href="#1-将多个页面中重复的代码抽取出来：" class="headerlink" title="1.将多个页面中重复的代码抽取出来："></a>1.将多个页面中重复的代码抽取出来：</h3><p><strong>写入单独的jsp文件中</strong><br><img src="/2020/04/08/javaweb-02/5.png" srcset="/img/loading.gif" alt></p>
<p>footer.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;div id=<span class="hljs-string">"bottom"</span>&gt;
      &lt;span&gt;
         尚硅谷书城.Copyright &amp;copy;<span class="hljs-number">2015</span>
      &lt;/span&gt;
&lt;/div&gt;</code></pre>

<p>header.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;% String basePath = request.getContextPath()+<span class="hljs-string">"/"</span>;%&gt;
&lt;!-- base标签永远固定相对路径跳转  --&gt;
&lt;base href=<span class="hljs-string">"&lt;%=basePath%&gt;"</span>&gt;
&lt;link type=<span class="hljs-string">"text/css"</span> rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"static/css/style.css"</span>&gt;
&lt;script type="text/javascript" src="static/script/jquery-3.4.1.js"&gt;&lt;/script&gt;</code></pre>

<p>login_success_menu.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;div&gt;
    &lt;span&gt;欢迎&lt;span class="um_span"&gt;张总&lt;/span&gt;光临尚硅谷书城&lt;/span&gt;
    &lt;a href="pages/order/order.jsp"&gt;我的订单&lt;/a&gt;
    &lt;a href="index.jsp"&gt;注销&lt;/a&gt;&amp;nbsp;&amp;nbsp;
    &lt;a href="index.jsp"&gt;返回&lt;/a&gt;
&lt;/div&gt;</code></pre>

<p>manage_menu.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;div&gt;
    &lt;a href="book_manager"&gt;图书管理&lt;/a&gt;
    &lt;a href="order_manager"&gt;订单管理&lt;/a&gt;
    &lt;a href="index.jsp"&gt;返回商城&lt;/a&gt;
&lt;/div&gt;</code></pre>

<p><strong>采用静态包含的方式替换重复的代码：</strong></p>
<pre><code class="hljs jsp"> &lt;%-- 静态包含 页脚内容--%&gt;
&lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/footer.jsp"</span>%&gt;</code></pre>

<pre><code class="hljs jsp">&lt;%-- 静态包含 base标签、css样式、jquery文件--%&gt;
   &lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/head.jsp"</span>%&gt;</code></pre>

<pre><code class="hljs jsp"> &lt;%-- 静态包含 成功之后的菜单--%&gt;
&lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/login_sucess_menu.jsp"</span>%</code></pre>

<pre><code class="hljs jsp"> &lt;%-- 静态包含 管理菜单--%&gt;
&lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/manage_menu.jsp"</span>%&gt;</code></pre>

<h3 id="2-登录、注册错误提示以及表单回显"><a href="#2-登录、注册错误提示以及表单回显" class="headerlink" title="2.登录、注册错误提示以及表单回显"></a>2.登录、注册错误提示以及表单回显</h3><p>LoginServlet.java</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        User loginUser = userService.login(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>, username, password, <span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">if</span> (loginUser == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">// System.out.println("登录失败！");</span>
            <span class="hljs-comment">// 将要回显的错误信息保存到request域中</span>
            req.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"用户名或密码错误！"</span>);
            req.setAttribute(<span class="hljs-string">"username"</span>,username);
            <span class="hljs-comment">// 跳转到首页</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login.jsp"</span>).forward(req, resp);
        &#125; <span class="hljs-keyword">else</span> &#123;
            System.out.println(<span class="hljs-string">"登录成功！"</span>);
            <span class="hljs-comment">// 跳转到登录成功页面</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login_success.jsp"</span>).forward(req, resp);
        &#125;
    &#125;
&#125;</code></pre>

<p>login.jsp</p>
<pre><code class="hljs jsp">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"msg_cont"</span>&gt;
   &lt;b&gt;&lt;/b&gt;
   &lt;span <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"errorMsg"</span>&gt;
      &lt;%=
         request.getAttribute(<span class="hljs-string">"msg"</span>)==<span class="hljs-keyword">null</span>?<span class="hljs-string">"请输入用户名和密码"</span>:request.getAttribute(<span class="hljs-string">"msg"</span>)
      %&gt;
   &lt;/span&gt;
&lt;/div&gt;</code></pre>

<pre><code class="hljs jsp">&lt;input <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"itxt"</span> type=<span class="hljs-string">"text"</span> placeholder=<span class="hljs-string">"请输入用户名"</span>
      autocomplete=<span class="hljs-string">"off"</span> tabindex=<span class="hljs-string">"1"</span> name=<span class="hljs-string">"username"</span>
      value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>username<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>username<span class="hljs-string">")%&gt;"</span>/&gt;</code></pre>

<p>RegistServlet.java</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegistServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        String email = req.getParameter(<span class="hljs-string">"email"</span>);
        String code = req.getParameter(<span class="hljs-string">"code"</span>);
        <span class="hljs-comment">// 2.检查验证码是否正确====先写死为qwer</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-string">"qwer"</span>.equalsIgnoreCase(code))&#123;
            <span class="hljs-comment">// 验证码正确</span>
            <span class="hljs-comment">// 3.检查用户名是否可用</span>
            <span class="hljs-keyword">if</span>(userService.existUsername(username))&#123;
                <span class="hljs-comment">// true 用户名已存在</span>
                <span class="hljs-comment">// System.out.println("用户名["+username+"]已存在！");</span>
                <span class="hljs-comment">// 把回显信息保存到request域中</span>
                req.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"用户名已存在！"</span>);
                req.setAttribute(<span class="hljs-string">"username"</span>,username);
                req.setAttribute(<span class="hljs-string">"email"</span>,email);
                <span class="hljs-comment">// 跳转到首页</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.jsp"</span>).forward(req,resp);
            &#125; <span class="hljs-keyword">else</span>&#123;
                <span class="hljs-comment">// false 用户名不存在  可以注册</span>
                userService.registUser(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>,username,password,email));
                <span class="hljs-comment">// 跳转到注册成功页面</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist_success.jsp"</span>).forward(req,resp);
            &#125;
        &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">// 验证码错误</span>
            <span class="hljs-comment">// System.out.println("验证码["+code+"]错误！");</span>
            <span class="hljs-comment">// 把错误信息和回显信息保存到request域中</span>
            req.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"验证码错误！"</span>);
            req.setAttribute(<span class="hljs-string">"username"</span>,username);
            req.setAttribute(<span class="hljs-string">"email"</span>,email);
            <span class="hljs-comment">// 跳转到首页</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.jsp"</span>).forward(req,resp);
        &#125;
    &#125;
&#125;</code></pre>

<p>regist.jsp</p>
<pre><code class="hljs jsp">&lt;span <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"errorMsg"</span>&gt;
    &lt;%=request.getAttribute(<span class="hljs-string">"msg"</span>)==<span class="hljs-keyword">null</span>?<span class="hljs-string">""</span>:request.getAttribute(<span class="hljs-string">"msg"</span>)%&gt;
&lt;/span&gt;</code></pre>

<pre><code class="hljs jsp">&lt;input <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"itxt"</span> type=<span class="hljs-string">"text"</span> placeholder=<span class="hljs-string">"请输入用户名"</span>
       autocomplete=<span class="hljs-string">"off"</span> tabindex=<span class="hljs-string">"1"</span>
       name=<span class="hljs-string">"username"</span> id=<span class="hljs-string">"username"</span>
       value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>username<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>username<span class="hljs-string">")%&gt;"</span>/&gt;</code></pre>

<pre><code class="hljs jsp">&lt;input <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"itxt"</span> type=<span class="hljs-string">"text"</span> placeholder=<span class="hljs-string">"请输入邮箱地址"</span> autocomplete=<span class="hljs-string">"off"</span> tabindex=<span class="hljs-string">"1"</span>
       name=<span class="hljs-string">"email"</span> id=<span class="hljs-string">"email"</span>
       value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>email<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>email<span class="hljs-string">")%&gt;"</span>/&gt;</code></pre>

<h3 id="3-将LoginServlet和RegistServlet合并为UserServlet"><a href="#3-将LoginServlet和RegistServlet合并为UserServlet" class="headerlink" title="3.将LoginServlet和RegistServlet合并为UserServlet"></a>3.将LoginServlet和RegistServlet合并为UserServlet</h3><p><img src="/2020/04/08/javaweb-02/6.png" srcset="/img/loading.gif" alt></p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取请求类型</span>
        String action = req.getParameter(<span class="hljs-string">"action"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"login"</span>.equals(action)) &#123;
            login(req, resp);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"regist"</span>.equals(action)) &#123;
            regist(req, resp);
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 处理登录的功能</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">login</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        User loginUser = userService.login(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>, username, password, <span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">if</span> (loginUser == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">// System.out.println("登录失败！");</span>
            <span class="hljs-comment">// 将要回显的错误信息保存到request域中</span>
            req.setAttribute(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"用户名或密码错误！"</span>);
            req.setAttribute(<span class="hljs-string">"username"</span>, username);
            <span class="hljs-comment">// 跳转到首页</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login.jsp"</span>).forward(req, resp);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// System.out.println("登录成功！");</span>
            <span class="hljs-comment">// 跳转到登录成功页面</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/login_success.jsp"</span>).forward(req, resp);
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 处理注册的功能</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">regist</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取请求参数</span>
        String username = req.getParameter(<span class="hljs-string">"username"</span>);
        String password = req.getParameter(<span class="hljs-string">"password"</span>);
        String email = req.getParameter(<span class="hljs-string">"email"</span>);
        String code = req.getParameter(<span class="hljs-string">"code"</span>);
        <span class="hljs-comment">// 2.检查验证码是否正确====先写死为qwer</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"qwer"</span>.equalsIgnoreCase(code)) &#123;
            <span class="hljs-comment">// 验证码正确</span>
            <span class="hljs-comment">// 3.检查用户名是否可用</span>
            <span class="hljs-keyword">if</span> (userService.existUsername(username)) &#123;
                <span class="hljs-comment">// true 用户名已存在</span>
                <span class="hljs-comment">// System.out.println("用户名["+username+"]已存在！");</span>
                <span class="hljs-comment">// 把回显信息保存到request域中</span>
                req.setAttribute(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"用户名已存在！"</span>);
                req.setAttribute(<span class="hljs-string">"username"</span>, username);
                req.setAttribute(<span class="hljs-string">"email"</span>, email);
                <span class="hljs-comment">// 跳转到首页</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.jsp"</span>).forward(req, resp);
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-comment">// false 用户名不存在  可以注册</span>
                userService.registUser(<span class="hljs-keyword">new</span> User(<span class="hljs-keyword">null</span>, username, password, email));
                <span class="hljs-comment">// 跳转到注册成功页面</span>
                req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist_success.jsp"</span>).forward(req, resp);
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// 验证码错误</span>
            <span class="hljs-comment">// System.out.println("验证码["+code+"]错误！");</span>
            <span class="hljs-comment">// 把错误信息和回显信息保存到request域中</span>
            req.setAttribute(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"验证码错误！"</span>);
            req.setAttribute(<span class="hljs-string">"username"</span>, username);
            req.setAttribute(<span class="hljs-string">"email"</span>, email);
            <span class="hljs-comment">// 跳转到首页</span>
            req.getRequestDispatcher(<span class="hljs-string">"/pages/user/regist.jsp"</span>).forward(req, resp);
        &#125;
    &#125;
&#125;</code></pre>

<p>login.jsp<br><img src="/2020/04/08/javaweb-02/7.png" srcset="/img/loading.gif" alt></p>
<p>regist.jsp<br><img src="/2020/04/08/javaweb-02/8.png" srcset="/img/loading.gif" alt></p>
<h3 id="4-使用反射优化大量else-if-代码"><a href="#4-使用反射优化大量else-if-代码" class="headerlink" title="4.使用反射优化大量else if 代码"></a>4.使用反射优化大量else if 代码</h3><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// 通过反射根据action属性值调用相应的方法</span>
    String action = req.getParameter(<span class="hljs-string">"action"</span>);
    <span class="hljs-keyword">try</span> &#123;
        Method method = UserServlet<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredMethod</span>(<span class="hljs-title">action</span>, <span class="hljs-title">HttpServletRequest</span>.<span class="hljs-title">class</span>, <span class="hljs-title">HttpServletResponse</span>.<span class="hljs-title">class</span>)</span>;
        method.invoke(<span class="hljs-keyword">this</span>,req, resp);
    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
        e.printStackTrace();
    &#125;
&#125;</code></pre>

<h3 id="5-抽取BaseServlet"><a href="#5-抽取BaseServlet" class="headerlink" title="5.抽取BaseServlet"></a>5.抽取BaseServlet</h3><p><img src="/2020/04/08/javaweb-02/10.png" srcset="/img/loading.gif" alt></p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.web;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        req.setCharacterEncoding(<span class="hljs-string">"utf-8"</span>);
        doPost(req, resp);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        req.setCharacterEncoding(<span class="hljs-string">"utf-8"</span>);
        <span class="hljs-comment">// 获取请求类型</span>
        String action = req.getParameter(<span class="hljs-string">"action"</span>);
        <span class="hljs-comment">// System.out.println(action);</span>
        <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">// 通过反射根据action属性值调用相应的方法</span>
            Method method = <span class="hljs-keyword">this</span>.getClass().getDeclaredMethod(action, HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">HttpServletResponse</span>.<span class="hljs-title">class</span>)</span>;
            method.invoke(<span class="hljs-keyword">this</span>, req, resp);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.web;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">login</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// ......</span>
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">regist</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    	<span class="hljs-comment">// ......</span>
    &#125;
&#125;</code></pre>

<h3 id="6-数据的封装和抽取-BeanUtils的使用"><a href="#6-数据的封装和抽取-BeanUtils的使用" class="headerlink" title="6.数据的封装和抽取 BeanUtils的使用"></a>6.数据的封装和抽取 BeanUtils的使用</h3><p>BeanUtils工具类，可以一次性的把所有请求的参数注入导JavaBean中<br>1、导入需要的jar 包：<br>commons-beanutils-1.8.0.jar<br>commons-logging-1.1.1jar<br>2、使用BeanUtils类方法实现注入</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.utils;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebUtils</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">copyParamToBean</span><span class="hljs-params">(Map map, T bean)</span></span>&#123;
        <span class="hljs-comment">// 将所有请求的参数封装到bean中</span>
        <span class="hljs-keyword">try</span> &#123;
            BeanUtils.populate(bean,map);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> bean;
    &#125;
&#125;</code></pre>

<p>UserServlet.java</p>
<pre><code class="hljs java"><span class="hljs-comment">// 将请求参数一次性封装到user对象中</span>
User user = WebUtils.copyParamToBean(req.getParameterMap(),<span class="hljs-keyword">new</span> User());</code></pre>

<h3 id="7-使用EL表达式修改表单回显"><a href="#7-使用EL表达式修改表单回显" class="headerlink" title="7.使用EL表达式修改表单回显"></a>7.使用EL表达式修改表单回显</h3><p>login.jsp</p>
<pre><code class="hljs jsp">&lt;%--
    &lt;%= request.getAttribute(<span class="hljs-string">"msg"</span>)==<span class="hljs-keyword">null</span>?<span class="hljs-string">"请输入用户名和密码"</span>:request.getAttribute(<span class="hljs-string">"msg"</span>)%&gt;
--%&gt;
$&#123;empty requestScope.msg ? <span class="hljs-string">"请输入用户名和密码"</span>:requestScope.msg&#125;</code></pre>

<pre><code class="hljs jsp">&lt;%--
    value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>username<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>username<span class="hljs-string">")%&gt;"</span>
--%&gt;
value=<span class="hljs-string">"$&#123;requestScope.username&#125;"</span></code></pre>

<p>regist.jsp</p>
<pre><code class="hljs jsp">&lt;%--
    &lt;%=request.getAttribute(<span class="hljs-string">"msg"</span>)==<span class="hljs-keyword">null</span>?<span class="hljs-string">""</span>:request.getAttribute(<span class="hljs-string">"msg"</span>)%&gt;
--%&gt;
$&#123;requestScope.msg&#125;</code></pre>

<pre><code class="hljs jsp">&lt;%--
    value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>username<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>username<span class="hljs-string">")%&gt;"</span>
--%&gt;
$&#123;requestScope.username&#125;</code></pre>

<pre><code class="hljs jsp">&lt;%--
    value=<span class="hljs-string">"&lt;%=request.getAttribute("</span>email<span class="hljs-string">")==null?"</span><span class="hljs-string">":request.getAttribute("</span>email<span class="hljs-string">")%&gt;"</span>
--%&gt;
$&#123;requestScope.email&#125;</code></pre>

<h2 id="十、图书模块"><a href="#十、图书模块" class="headerlink" title="十、图书模块"></a>十、图书模块</h2><h3 id="1-创建图书模块的数据库表"><a href="#1-创建图书模块的数据库表" class="headerlink" title="1.创建图书模块的数据库表"></a>1.创建图书模块的数据库表</h3><pre><code class="hljs sql"><span class="hljs-keyword">USE</span> bookmall;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> book(
	<span class="hljs-string">`id`</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> auto_increment,
	<span class="hljs-string">`name`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`price`</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`author`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`sales`</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`stock`</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
	<span class="hljs-string">`img_path`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
<span class="hljs-comment"># drop table book;</span>

<span class="hljs-comment">## 插入初始化测试数据</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'java从入门到放弃'</span> , <span class="hljs-string">'国哥'</span> , <span class="hljs-number">80</span> , <span class="hljs-number">9999</span> , <span class="hljs-number">9</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'数据结构与算法'</span> , <span class="hljs-string">'严敏君'</span> , <span class="hljs-number">78.5</span> , <span class="hljs-number">6</span> , <span class="hljs-number">13</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'编程珠玑'</span> , <span class="hljs-string">'Tom'</span> , <span class="hljs-number">68</span>, <span class="hljs-number">99999</span> , <span class="hljs-number">52</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'从你的全世界路过'</span> , <span class="hljs-string">'张嘉加'</span> , <span class="hljs-number">16</span>, <span class="hljs-number">1000</span> , <span class="hljs-number">50</span> , <span class="hljs-string">'static/img/cover.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'C++编程思想'</span> , <span class="hljs-string">'刚哥'</span> , <span class="hljs-number">45.5</span> , <span class="hljs-number">14</span> , <span class="hljs-number">95</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'蛋炒饭'</span> , <span class="hljs-string">'周星星'</span> , <span class="hljs-number">9.9</span>, <span class="hljs-number">12</span> , <span class="hljs-number">53</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'Java编程思想'</span> , <span class="hljs-string">'阳哥'</span> , <span class="hljs-number">99.5</span> , <span class="hljs-number">47</span> , <span class="hljs-number">36</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'JavaScript从入门到精通'</span> , <span class="hljs-string">'婷姐'</span> , <span class="hljs-number">9.9</span> , <span class="hljs-number">85</span> , <span class="hljs-number">95</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'C语言程序设计'</span> , <span class="hljs-string">'谭浩强'</span> , <span class="hljs-number">28</span> , <span class="hljs-number">52</span> , <span class="hljs-number">74</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'Lua语言程序设计'</span> , <span class="hljs-string">'雷丰阳'</span> , <span class="hljs-number">51.5</span> , <span class="hljs-number">48</span> , <span class="hljs-number">82</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'西游记'</span> , <span class="hljs-string">'罗贯中'</span> , <span class="hljs-number">12</span>, <span class="hljs-number">19</span> , <span class="hljs-number">9999</span> , <span class="hljs-string">'static/img/default.jpg'</span>);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'水浒传'</span> , <span class="hljs-string">'华仔'</span> , <span class="hljs-number">33.05</span> , <span class="hljs-number">22</span> , <span class="hljs-number">88</span> , <span class="hljs-string">'static/img/default.jpg'</span>);
 
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'操作系统原理'</span> , <span class="hljs-string">'刘优'</span> , <span class="hljs-number">133.05</span> , <span class="hljs-number">122</span> , <span class="hljs-number">188</span> , <span class="hljs-string">'static/img/default.jpg'</span>);
 
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'数据结构 java版'</span> , <span class="hljs-string">'封大神'</span> , <span class="hljs-number">173.15</span> , <span class="hljs-number">21</span> , <span class="hljs-number">81</span> , <span class="hljs-string">'static/img/default.jpg'</span>);
 
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'UNIX高级环境编程'</span> , <span class="hljs-string">'乐天'</span> , <span class="hljs-number">99.15</span> , <span class="hljs-number">210</span> , <span class="hljs-number">810</span> , <span class="hljs-string">'static/img/default.jpg'</span>);
 
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> book(<span class="hljs-string">`id`</span> , <span class="hljs-string">`name`</span> , <span class="hljs-string">`author`</span> , <span class="hljs-string">`price`</span> , <span class="hljs-string">`sales`</span> , <span class="hljs-string">`stock`</span> , <span class="hljs-string">`img_path`</span>) 
<span class="hljs-keyword">values</span>(<span class="hljs-literal">null</span> , <span class="hljs-string">'javaScript高级编程'</span> , <span class="hljs-string">'国哥'</span> , <span class="hljs-number">69.15</span> , <span class="hljs-number">210</span> , <span class="hljs-number">810</span> , <span class="hljs-string">'static/img/default.jpg'</span>);</code></pre>

<h3 id="2-编写图书模块的JavaBean对象"><a href="#2-编写图书模块的JavaBean对象" class="headerlink" title="2.编写图书模块的JavaBean对象"></a>2.编写图书模块的JavaBean对象</h3><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.bean;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String author;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> Integer sales;
    <span class="hljs-keyword">private</span> Integer stock;
    <span class="hljs-keyword">private</span> String imgPath;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Book</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Book</span><span class="hljs-params">(Integer id, String name, String author, BigDecimal price, Integer sales, Integer stock, String imgPath)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.author = author;
        <span class="hljs-keyword">this</span>.price = price;
        <span class="hljs-keyword">this</span>.sales = sales;
        <span class="hljs-keyword">this</span>.stock = stock;
        <span class="hljs-keyword">if</span> (imgPath != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-string">""</span>.equals(imgPath)) &#123;
            <span class="hljs-keyword">this</span>.imgPath = imgPath;
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.name = name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAuthor</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> author;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthor</span><span class="hljs-params">(String author)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.author = author;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPrice</span><span class="hljs-params">(BigDecimal price)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.price = price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getSales</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sales;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSales</span><span class="hljs-params">(Integer sales)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.sales = sales;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getStock</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> stock;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStock</span><span class="hljs-params">(Integer stock)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.stock = stock;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getImgPath</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> imgPath;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setImgPath</span><span class="hljs-params">(String imgPath)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (imgPath != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-string">""</span>.equals(imgPath)) &#123;
            <span class="hljs-keyword">this</span>.imgPath = imgPath;
        &#125;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Book&#123;"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", author='"</span> + author + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", price="</span> + price +
                <span class="hljs-string">", sales="</span> + sales +
                <span class="hljs-string">", stock="</span> + stock +
                <span class="hljs-string">", imgPath='"</span> + imgPath + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<h3 id="3-编写图书模块的DAO并测试"><a href="#3-编写图书模块的DAO并测试" class="headerlink" title="3.编写图书模块的DAO并测试"></a>3.编写图书模块的DAO并测试</h3><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.dao.impl;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BookDao</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addBook</span><span class="hljs-params">(Book book)</span> </span>&#123;
        String sql = <span class="hljs-string">"insert into book(`name`,`author`,`price`,`sales`,`stock`,`img_path`) values(?,?,?,?,?,?)"</span>;
        <span class="hljs-keyword">return</span> update(sql, book.getName(),book.getAuthor(),book.getPrice(),book.getSales(),book.getStock(),book.getImgPath());
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">deleteBook</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        String sql = <span class="hljs-string">"delete from book where id = ?"</span>;
        <span class="hljs-keyword">return</span> update(sql,id);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateBook</span><span class="hljs-params">(Book book)</span> </span>&#123;
        String sql = <span class="hljs-string">"update book set `name`=?,`author`=?,`price`=?,`sales`=?,`stock`=?,`img_path`= ? where id = ?"</span>;
        <span class="hljs-keyword">return</span> update(sql,book.getName(),book.getAuthor(),book.getPrice(),book.getSales(),book.getStock(),book.getImgPath(),book.getId());
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">queryBookById</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        String sql = <span class="hljs-string">"select `id`,`name`,`author`,`price`,`sales`,`stock`,`img_path` imgPath from book where id = ?"</span>;
        <span class="hljs-keyword">return</span> queryForOne(Book<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>,<span class="hljs-title">id</span>)</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">queryBooks</span><span class="hljs-params">()</span> </span>&#123;
        String sql = <span class="hljs-string">"select `id`,`name`,`author`,`price`,`sales`,`stock`,`img_path` imgPath from book"</span>;
        <span class="hljs-keyword">return</span> queryForList(Book<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>)</span>;
    &#125;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.test;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookDaoImplTest</span> </span>&#123;
    <span class="hljs-keyword">private</span> BookDao bookDao = <span class="hljs-keyword">new</span> BookDaoImpl();

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addBook</span><span class="hljs-params">()</span> </span>&#123;
        bookDao.addBook(<span class="hljs-keyword">new</span> Book(<span class="hljs-keyword">null</span>,<span class="hljs-string">"算法与数据结构(java版)"</span>,<span class="hljs-string">"张三三"</span>,<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">58.80</span>),<span class="hljs-number">20</span>,<span class="hljs-number">100</span>,<span class="hljs-string">"static/img/default.jpg"</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteBook</span><span class="hljs-params">()</span> </span>&#123;
        bookDao.deleteBook(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateBook</span><span class="hljs-params">()</span> </span>&#123;
        bookDao.updateBook(<span class="hljs-keyword">new</span> Book(<span class="hljs-number">21</span>,<span class="hljs-string">"算法与数据结构(C++版)"</span>,<span class="hljs-string">"张三三"</span>,<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">58.80</span>),<span class="hljs-number">20</span>,<span class="hljs-number">100</span>,<span class="hljs-string">"static/img/default.jpg"</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryBookById</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(bookDao.queryBookById(<span class="hljs-number">21</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryBooks</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">for</span>(Book book:bookDao.queryBooks())&#123;
            System.out.println(book);
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="4-编写图书模块的Service并测试"><a href="#4-编写图书模块的Service并测试" class="headerlink" title="4.编写图书模块的Service并测试"></a>4.编写图书模块的Service并测试</h3><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.service.impl;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BookService</span> </span>&#123;
    <span class="hljs-keyword">private</span> BookDao bookDao = <span class="hljs-keyword">new</span> BookDaoImpl();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addBook</span><span class="hljs-params">(Book book)</span> </span>&#123;
        bookDao.addBook(book);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteBook</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        bookDao.deleteBook(id);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateBook</span><span class="hljs-params">(Book book)</span> </span>&#123;
        bookDao.updateBook(book);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">queryBookById</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">return</span> bookDao.queryBookById(id);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">queryBooks</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> bookDao.queryBooks();
    &#125;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.test;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookServiceImplTest</span> </span>&#123;
    <span class="hljs-keyword">private</span> BookService bookService = <span class="hljs-keyword">new</span> BookServiceImpl();
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addBook</span><span class="hljs-params">()</span> </span>&#123;
        bookService.addBook(<span class="hljs-keyword">new</span> Book(<span class="hljs-keyword">null</span>,<span class="hljs-string">"肉蛋葱鸡"</span>,<span class="hljs-string">"马老师"</span>,<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">66.66</span>),<span class="hljs-number">666</span>,<span class="hljs-number">66</span>,<span class="hljs-string">"static/img/cover.jpg"</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteBook</span><span class="hljs-params">()</span> </span>&#123;
        bookService.deleteBook(<span class="hljs-number">10</span>);
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateBook</span><span class="hljs-params">()</span> </span>&#123;
        bookService.updateBook(<span class="hljs-keyword">new</span> Book(<span class="hljs-number">7</span>,<span class="hljs-string">"红皮烤鸭"</span>,<span class="hljs-string">"马老师"</span>,<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">99.8</span>),<span class="hljs-number">100</span>,<span class="hljs-number">2</span>,<span class="hljs-string">"static/img/cover.jpg"</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryBookById</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(bookService.queryBookById(<span class="hljs-number">7</span>));
    &#125;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryBooks</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">for</span>(Book book :bookService.queryBooks())&#123;
            System.out.println(book);
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="5-编写图书模块的Web层，和页面联调测试"><a href="#5-编写图书模块的Web层，和页面联调测试" class="headerlink" title="5.编写图书模块的Web层，和页面联调测试"></a>5.编写图书模块的Web层，和页面联调测试</h3><h4 id="1、实现展示全部图书"><a href="#1、实现展示全部图书" class="headerlink" title="1、实现展示全部图书"></a>1、实现展示全部图书</h4><p><img src="/2020/04/08/javaweb-02/11.png" srcset="/img/loading.gif" alt></p>
<p><strong>在BookServlet.java中添加list()方法用于展示全部图书信息：</strong></p>
<pre><code class="hljs java"><span class="hljs-keyword">private</span> BookService bookService = <span class="hljs-keyword">new</span> BookServiceImpl();
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">list</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// 1.通过BookService查询全部图书</span>
    List&lt;Book&gt; books = bookService.queryBooks();
    <span class="hljs-comment">// 2.将全部的图书信息保存到request域中</span>
    req.setAttribute(<span class="hljs-string">"books"</span>,books);
    <span class="hljs-comment">// 3.请求转发</span>
    req.getRequestDispatcher(<span class="hljs-string">"/pages/manager/book_manager.jsp"</span>).forward(req,resp);
&#125;</code></pre>

<p><strong>修改图书管理页面的跳转地址：</strong><br><img src="/2020/04/08/javaweb-02/12.png" srcset="/img/loading.gif" alt></p>
<p><strong>利用JSTL标签库遍历图书信息在jsp页面中输出：</strong><br>1、导入JSTL标签库的jar包<br>taglibs-standard-impl-1.2.1.jar<br>taglibs-standard-spec-1.2.1.jar<br>2、在book_manager.jsp中编写遍历图书信息的代码</p>
<pre><code class="hljs jsp">&lt;c:forEach items=<span class="hljs-string">"$&#123;requestScope.books&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"book"</span>&gt;
	&lt;tr&gt;
		&lt;td&gt;$&#123;book.name&#125;&lt;/td&gt;
		&lt;td&gt;$&#123;book.price&#125;&lt;/td&gt;
		&lt;td&gt;$&#123;book.author&#125;&lt;/td&gt;
		&lt;td&gt;$&#123;book.sales&#125;&lt;/td&gt;
		&lt;td&gt;$&#123;book.stock&#125;&lt;/td&gt;
		&lt;td&gt;&lt;a href="book_edit"&gt;修改&lt;/a&gt;&lt;/td&gt;
		&lt;td&gt;&lt;a href="#"&gt;删除&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/c:forEach&gt;</code></pre>

<h4 id="2、实现添加图书"><a href="#2、实现添加图书" class="headerlink" title="2、实现添加图书"></a>2、实现添加图书</h4><p><img src="/2020/04/08/javaweb-02/17.png" srcset="/img/loading.gif" alt></p>
<p><strong>在BookServlet中添加add()方法用于添加图书：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">//  1、获取请求的参数==封装成为Book对象</span>
        Book book = WebUtils.copyParamToBean(req.getParameterMap(), <span class="hljs-keyword">new</span> Book());
        <span class="hljs-comment">//  2、调用BookService.addBook()保存图书</span>
        bookService.addBook(book);
        <span class="hljs-comment">// 3、跳到图书列表页面 /manager/bookServlet?action=list</span>
        <span class="hljs-comment">// 请求转发会造成表单的多次提交</span>
        <span class="hljs-comment">// req.getRequestDispatcher("/manager/bookServlet?action=list").forward(req, resp);</span>

        <span class="hljs-comment">// 请求重定向</span>
        resp.sendRedirect(req.getContextPath()+ <span class="hljs-string">"/manager/bookServlet?action=list"</span>);
    &#125;</code></pre>

<p><strong>修改book_edit.jsp：</strong><br><img src="/2020/04/08/javaweb-02/13.png" srcset="/img/loading.gif" alt></p>
<p><img src="/2020/04/08/javaweb-02/14.png" srcset="/img/loading.gif" alt></p>
<h4 id="3、实现删除图书"><a href="#3、实现删除图书" class="headerlink" title="3、实现删除图书"></a>3、实现删除图书</h4><p><img src="/2020/04/08/javaweb-02/18.png" srcset="/img/loading.gif" alt></p>
<p><strong>在BookServlet中添加delete()方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
       <span class="hljs-comment">// 1、获取图书id</span>
       <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
       <span class="hljs-comment">// 2、调用BookService.deleteById() 删除图书</span>
       bookService.deleteBook(id);
       <span class="hljs-comment">// 3、重定向 /manager/bookServlet?action=list</span>
       resp.sendRedirect(req.getScheme()+<span class="hljs-string">"://"</span>+ req.getServerName()+<span class="hljs-string">":"</span>+
               req.getServerPort()+req.getContextPath()+ <span class="hljs-string">"/manager/bookServlet?action=list"</span>);
   &#125;</code></pre>

<p><strong>修改book_manager.jsp：</strong><br><img src="/2020/04/08/javaweb-02/15.png" srcset="/img/loading.gif" alt></p>
<p><strong>添加确认删除提示：</strong><br>给a标签添加class属性用于对标签选择<br><img src="/2020/04/08/javaweb-02/16.png" srcset="/img/loading.gif" alt>给a标签绑定单击事件：</p>
<pre><code class="hljs javascript"> &lt;%-- 给删除按钮绑定单击事件 用于删除操作的确认	--%&gt;
&lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
    <span class="hljs-comment">// 在事件的function函数中，有一个this对象，表示当前正在响应事件的dom对象</span>
	$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
		$(<span class="hljs-string">"a.deleteClass"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
			<span class="hljs-comment">// 确认返回true  取消返回false</span>
			<span class="hljs-keyword">return</span> confirm(<span class="hljs-string">"你确定删除《"</span> + $(<span class="hljs-keyword">this</span>).parent().parent().find(<span class="hljs-string">"td:first"</span>).text() +<span class="hljs-string">"》吗？"</span>);
			<span class="hljs-comment">// return false; 阻止元素的默认行为  不提交</span>
		&#125;);
	&#125;);
&lt;<span class="hljs-regexp">/script&gt;</span></code></pre>

<h4 id="4、实现修改图书"><a href="#4、实现修改图书" class="headerlink" title="4、实现修改图书"></a>4、实现修改图书</h4><p><img src="/2020/04/08/javaweb-02/19.png" srcset="/img/loading.gif" alt></p>
<p><strong>在bookServlet中添加getBook()用于获取要修改图书的信息：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getBook</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
       <span class="hljs-comment">// 1.获取id</span>
       <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
       <span class="hljs-comment">// 2.调用BookService.queryBookById() 获取图书信息</span>
       Book book = bookService.queryBookById(id);
       <span class="hljs-comment">// 3.将图书信息保存至request域中</span>
       req.setAttribute(<span class="hljs-string">"book"</span>,book);
       <span class="hljs-comment">// 4.请求转发到 /pages/manager/book_edit.jsp</span>
       req.getRequestDispatcher(<span class="hljs-string">"/pages/manager/book_edit.jsp"</span>).forward(req,resp);
   &#125;</code></pre>

<p><strong>修改book_edit.jsp让数据回显：</strong><br><img src="/2020/04/08/javaweb-02/20.png" srcset="/img/loading.gif" alt></p>
<p><strong>在BookServlet中添加update()方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// 1.获取从book_edit.jsp提交的表单数据  将数据封装到book对象中</span>
    Book book = WebUtils.copyParamToBean(req.getParameterMap(),<span class="hljs-keyword">new</span> Book());
    <span class="hljs-comment">// 2.调用BookService.update()更新图书</span>
    bookService.updateBook(book);
    <span class="hljs-comment">// 3.重定向 manager/bookServlet?action=list 刷新图书列表</span>
    resp.sendRedirect(req.getContextPath()+ <span class="hljs-string">"/manager/bookServlet?action=list"</span>);
&#125;</code></pre>

<p><strong>在book_edit.jsp中添加隐藏域用于回传修改图书所需要的id值：</strong><br><img src="/2020/04/08/javaweb-02/21.png" srcset="/img/loading.gif" alt></p>
<p><strong>图书信息并没有发生修改的原因：</strong><br>book_edit.jsp页面中既要进行添加add操作，又要进行修改update操作，最终进行何种操作是根据一个隐藏域决定的，因此需要动态修改隐藏域：在请求发起时附带上要执行操作的值，并注入隐藏域中。<br>传入update参数：<img src="/2020/04/08/javaweb-02/22.png" srcset="/img/loading.gif" style="zoom:100%;"><br>传入add参数：<img src="/2020/04/08/javaweb-02/23.png" srcset="/img/loading.gif" alt><br>注入隐藏域：<img src="/2020/04/08/javaweb-02/24.png" srcset="/img/loading.gif" alt></p>
<h4 id="5、实现图书的分页"><a href="#5、实现图书的分页" class="headerlink" title="5、实现图书的分页"></a>5、实现图书的分页</h4><p><img src="/2020/04/08/javaweb-02/25.png" srcset="/img/loading.gif" alt><br><strong>创建Page对象：</strong></p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.bean;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Page为分页的模型</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; 是具体的模块的 JavaBean 对象</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer PAGE_SIZE = <span class="hljs-number">4</span>;
    <span class="hljs-comment">// 当前页码</span>
    <span class="hljs-keyword">private</span> Integer pageNo;
    <span class="hljs-comment">// 总页码</span>
    <span class="hljs-keyword">private</span> Integer pageTotal;
    <span class="hljs-comment">// 总记录数</span>
    <span class="hljs-keyword">private</span> Integer pageTotalCount;
    <span class="hljs-comment">// 每页显示的数量</span>
    <span class="hljs-keyword">private</span> Integer pageSize = PAGE_SIZE;
    <span class="hljs-comment">// 当前页的数据</span>
    <span class="hljs-keyword">private</span> List&lt;T&gt; items;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Page</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Page</span><span class="hljs-params">(Integer pageNo, Integer pageTotal, Integer pageTotalCount, Integer pageSize, List&lt;T&gt; items)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.pageNo = pageNo;
        <span class="hljs-keyword">this</span>.pageTotal = pageTotal;
        <span class="hljs-keyword">this</span>.pageTotalCount = pageTotalCount;
        <span class="hljs-keyword">this</span>.pageSize = pageSize;
        <span class="hljs-keyword">this</span>.items = items;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title">getPageSize</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> PAGE_SIZE;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPageSize</span><span class="hljs-params">(Integer pageSize)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.pageSize = pageSize;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getItems</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> items;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setItems</span><span class="hljs-params">(List&lt;T&gt; items)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.items = items;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getPageNo</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> pageNo;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPageNo</span><span class="hljs-params">(Integer pageNo)</span> </span>&#123;
        <span class="hljs-comment">// 对页码进行检查</span>
        <span class="hljs-keyword">if</span>(pageNo&lt;<span class="hljs-number">1</span>)&#123;
            pageNo = <span class="hljs-number">1</span>;
        &#125;
        <span class="hljs-keyword">if</span> (pageNo&gt;pageTotal)&#123;
            pageNo = pageTotal;
        &#125;
        <span class="hljs-keyword">this</span>.pageNo = pageNo;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getPageTotal</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> pageTotal;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPageTotal</span><span class="hljs-params">(Integer pageTotal)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.pageTotal = pageTotal;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getPageTotalCount</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> pageTotalCount;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPageTotalCount</span><span class="hljs-params">(Integer pageTotalCount)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.pageTotalCount = pageTotalCount;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Page&#123;"</span> +
                <span class="hljs-string">"pageNo="</span> + pageNo +
                <span class="hljs-string">", pageTotal="</span> + pageTotal +
                <span class="hljs-string">", pageTotalCount="</span> + pageTotalCount +
                <span class="hljs-string">", pageSize="</span> + pageSize +
                <span class="hljs-string">", items="</span> + items +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<p><strong>在BookServlet中添page()用于处理分页：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">page</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 1.获取js页面传来的请求参数 pageNo 和 pageSize</span>
        <span class="hljs-keyword">int</span> pageNo = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageNo"</span>),<span class="hljs-number">1</span>);
        <span class="hljs-keyword">int</span> pageSize = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageSize"</span>), Page.PAGE_SIZE);
        <span class="hljs-comment">// 2.调用BookService.page(pageNo,pageSize) 得到Page对象</span>
        Page&lt;Book&gt; page = bookService.page(pageNo, pageSize);
        <span class="hljs-comment">// 3.将Page对象保存到Request域中</span>
        req.setAttribute(<span class="hljs-string">"page"</span>,page);
        <span class="hljs-comment">// 4.请求转发到 /pages/manager/book_manager.jsp</span>
        req.getRequestDispatcher(<span class="hljs-string">"/pages/manager/book_manager.jsp"</span>).forward(req,resp);
    &#125;</code></pre>

<p><strong>在BookService中添加page(pageNo,pageSize) 获取page对象：</strong></p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询分页</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageNo</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageSize</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回一个Page对象</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Page&lt;Book&gt; <span class="hljs-title">page</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNo, <span class="hljs-keyword">int</span> pageSize)</span></span>;</code></pre>

<p><strong>在BookServiceImpl中实现page(pageNo,pageSize)：</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Page&lt;Book&gt; <span class="hljs-title">page</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNo, <span class="hljs-keyword">int</span> pageSize)</span> </span>&#123;
       Page&lt;Book&gt; bookPage = <span class="hljs-keyword">new</span> Page&lt;&gt;();
       <span class="hljs-comment">//设置每页显示的数量</span>
       bookPage.setPageSize(pageSize);
       <span class="hljs-comment">// 设置总记录数</span>
       Integer pageTotalCount = bookDao.queryForPageTotalCount();
       bookPage.setPageTotalCount(pageTotalCount);
       <span class="hljs-comment">// 设置总页码</span>
       Integer pageTotal = pageTotalCount/pageSize;
       <span class="hljs-keyword">if</span> (pageTotalCount % pageSize&gt;<span class="hljs-number">0</span>)&#123;
           pageTotal++;
       &#125;
       bookPage.setPageTotal(pageTotal);
       <span class="hljs-comment">// 设置当前页码</span>
       bookPage.setPageNo(pageNo);
       <span class="hljs-comment">// 设置当页数据</span>
       <span class="hljs-keyword">int</span> begin = (bookPage.getPageNo()-<span class="hljs-number">1</span>)*pageSize;
       bookPage.setItems(bookDao.queryForItems(begin,pageSize));
       <span class="hljs-keyword">return</span> bookPage;
   &#125;</code></pre>

<p><strong>在BookDao中添加queryForPageTotal()和queryForItems()方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 查询图书的总记录数</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">queryForPageTotalCount</span><span class="hljs-params">()</span></span>;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 查询当前页面的图书记录</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> begin</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageSize</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">queryForItems</span><span class="hljs-params">(<span class="hljs-keyword">int</span> begin, <span class="hljs-keyword">int</span> pageSize)</span></span>;</code></pre>

<p><strong>在BookDaoImpl中实现queryForPageTotal()和queryForItems()方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">queryForPageTotalCount</span><span class="hljs-params">()</span> </span>&#123;
    String sql = <span class="hljs-string">"select count(*) from book"</span>;
    Number count = (Number) queryForSingleValue(sql);
    <span class="hljs-keyword">return</span>  count.intValue();
&#125;

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">queryForItems</span><span class="hljs-params">(<span class="hljs-keyword">int</span> begin, <span class="hljs-keyword">int</span> pageSize)</span> </span>&#123;
    String sql = <span class="hljs-string">" select `id`, `name`,`author`,`price`,`sales`,`stock`,`img_path` imgPath from book limit ?,?"</span>;
    <span class="hljs-keyword">return</span> queryForList(Book<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>,<span class="hljs-title">begin</span>,<span class="hljs-title">pageSize</span>)</span>;
&#125;</code></pre>

<p><strong>修改manage_menu.jsp页面显示分页后的内容：</strong><br><img src="/2020/04/08/javaweb-02/26.png" srcset="/img/loading.gif" alt></p>
<p><strong>修改book_manage.jsp页面，让下方显示页面跳转的功能按键：</strong></p>
<pre><code class="hljs jsp">&lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
       <span class="hljs-comment">// 在事件的function函数中，有一个this对象，表示当前正在响应事件的dom对象</span>
       $(function () &#123;
           &lt;%-- 给删除按钮绑定单击事件 用于删除操作的确认	--%&gt;
           $(<span class="hljs-string">"a.deleteClass"</span>).click(function () &#123;
               <span class="hljs-comment">// 确认返回true  取消返回false</span>
               <span class="hljs-keyword">return</span> confirm(<span class="hljs-string">"你确定删除《"</span> + $(<span class="hljs-keyword">this</span>).parent().parent().find(<span class="hljs-string">"td:first"</span>).text() + <span class="hljs-string">"》吗？"</span>);
               <span class="hljs-comment">// return false; 阻止元素的默认行为  不提交</span>
           &#125;);

           $(<span class="hljs-string">"#searchPageBtn"</span>).click(function () &#123;
               <span class="hljs-keyword">var</span> pageNo = $(<span class="hljs-string">"#pn_input"</span>).val();
               location.href = <span class="hljs-string">"$&#123;pageScope.basePath&#125;manager/bookServlet?action=page&amp;pageNo="</span> + pageNo;
           &#125;);
       &#125;);
   &lt;/script&gt;</code></pre>

<p>修改hesd.jsp 将basePath保存至pageContext域中：供指定页面跳转时使用<br><img src="/2020/04/08/javaweb-02/27.png" srcset="/img/loading.gif" alt></p>
<pre><code class="hljs jsp">&lt;div id=<span class="hljs-string">"page_nav"</span>&gt;
    &lt;%-- 大于首页才显示--%&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;1&#125;"</span>&gt;
        &lt;a href="manager/bookServlet?action=page&amp;pageNo=1"&gt;首页&lt;/a&gt;
        &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageNo-1&#125;"&gt;上一页&lt;/a&gt;
    &lt;/c:if&gt;

    &lt;%--  页码输出的开始--%&gt;
    &lt;c:choose&gt;
        &lt;%-- 情况<span class="hljs-number">1</span>：如果总页码&lt;=<span class="hljs-number">5</span>,页码的范围是<span class="hljs-number">1</span>~总页码 --%&gt;
        &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&lt;=5&#125;"</span>&gt;
            &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                    【$&#123;i&#125;】
                &lt;/c:if&gt;
                &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                    &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                &lt;/c:if&gt;
            &lt;/c:forEach&gt;
        &lt;/c:when&gt;
        &lt;%--情况<span class="hljs-number">2</span>：总页码&gt;<span class="hljs-number">5</span> --%&gt;
        &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&gt;5&#125;"</span>&gt;
            &lt;c:choose&gt;
                &lt;%-- 当前页码为前面<span class="hljs-number">3</span>个：页码范围是：<span class="hljs-number">1</span>~<span class="hljs-number">5</span>--%&gt;
                &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;=3&#125;"</span>&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"5"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:when&gt;
                &lt;%-- 当前页码为后面<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~末页--%&gt;
                &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;=requestScope.page.pageTotal-2&#125;"</span>&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-4&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:when&gt;
                &lt;%-- 当前页码为中间<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~当前页码+<span class="hljs-number">2</span>--%&gt;
                &lt;c:otherwise&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-2&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageNo+2&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:otherwise&gt;
            &lt;/c:choose&gt;
        &lt;/c:when&gt;
    &lt;/c:choose&gt;
    &lt;%--  页码输出的结束--%&gt;

    &lt;%--  小于末页才显示--%&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;requestScope.page.pageTotal&#125;"</span>&gt;
        &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageNo+1&#125;"&gt;下一页&lt;/a&gt;
        &lt;a href="manager/bookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageTotal&#125;"&gt;末页&lt;/a&gt;
    &lt;/c:if&gt;
    共$&#123;requestScope.page.pageTotal&#125;页，$&#123;requestScope.page.pageTotalCount&#125;条记录
    到第&lt;input value=<span class="hljs-string">"$&#123;param.pageNo&#125;"</span> name=<span class="hljs-string">"pn"</span> id=<span class="hljs-string">"pn_input"</span>/&gt;页
    &lt;input id=<span class="hljs-string">"searchPageBtn"</span> type=<span class="hljs-string">"button"</span> value=<span class="hljs-string">"确定"</span>&gt;
&lt;/div&gt;</code></pre>

<p><strong>修改增删改操作的重定向地址并传入pageNo参数：</strong><br><img src="/2020/04/08/javaweb-02/28.png" srcset="/img/loading.gif" alt></p>
<p><strong>在book_manager.jsp传入页码pageNo：</strong><br><img src="/2020/04/08/javaweb-02/29.png" srcset="/img/loading.gif" alt></p>
<p><strong>在book_edit.jsp中添加隐藏域用于传递pageNo给BookServlet：</strong><br><img src="/2020/04/08/javaweb-02/30.png" srcset="/img/loading.gif" alt></p>
<p><strong>前台图书的分页展示：</strong>|<br><img src="/2020/04/08/javaweb-02/31.png" srcset="/img/loading.gif" alt></p>
<p>web目录下的index.jsp只负责转发：</p>
<pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;

&lt;%--只负责请求转发--%&gt;
&lt;jsp:forward page="/client/clientBookServlet?action=page"&gt;&lt;/jsp:forward&gt;</code></pre>

<p>创建ClientBookServlet用于处理前台的分页请求：</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.web;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientBookServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseServlet</span> </span>&#123;

    <span class="hljs-keyword">private</span> BookService bookService = <span class="hljs-keyword">new</span> BookServiceImpl();
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 处理图书分页</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">page</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        System.out.println(<span class="hljs-string">"经过了前台的ClientBookServlet"</span>);
        <span class="hljs-comment">// 1.获取js页面传来的请求参数 pageNo 和 pageSize</span>
        <span class="hljs-keyword">int</span> pageNo = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageNo"</span>),<span class="hljs-number">1</span>);
        <span class="hljs-keyword">int</span> pageSize = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageSize"</span>), Page.PAGE_SIZE);
        <span class="hljs-comment">// 2.调用BookService.page(pageNo,pageSize) 得到Page对象</span>
        Page&lt;Book&gt; page = bookService.page(pageNo, pageSize);
        <span class="hljs-comment">// 3.将Page对象保存到Request域中</span>
        req.setAttribute(<span class="hljs-string">"page"</span>,page);
        <span class="hljs-comment">// 4.请求转发到 /pages/client/index.jsp</span>
        req.getRequestDispatcher(<span class="hljs-string">"/pages/client/index.jsp"</span>).forward(req,resp);
    &#125;
&#125;</code></pre>

<p>在web目录的/page/client/路径下创建index.jsp用于显示前台图书信息：</p>
<pre><code class="hljs jsp">&lt;%@ taglib prefix=<span class="hljs-string">"c"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;
&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=<span class="hljs-string">"UTF-8"</span>&gt;
    &lt;title&gt;书城首页&lt;/title&gt;
    &lt;%-- 静态包含 base标签、css样式、jquery文件   --%&gt;
    &lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/head.jsp"</span> %&gt;
    &lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
        $(function()&#123;
            $(<span class="hljs-string">"#searchPageBtn"</span>).click(function()&#123;
                <span class="hljs-keyword">var</span> pageNo = $(<span class="hljs-string">"#pn_input"</span>).val();
                location.href = <span class="hljs-string">"$&#123;pageScope.basePath&#125;client/clientBookServlet?action=page&amp;pageNo="</span>+pageNo;
            &#125;);
        &#125;)
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div id=<span class="hljs-string">"header"</span>&gt;

    &lt;span class="wel_word"&gt;网上书城&lt;/span&gt;
    &lt;div&gt;
        &lt;a href="pages/user/login.jsp"&gt;登录&lt;/a&gt; |
        &lt;a href="pages/user/regist.jsp"&gt;注册&lt;/a&gt; &amp;nbsp;&amp;nbsp;
        &lt;a href="pages/cart/cart.jsp"&gt;购物车&lt;/a&gt;
        &lt;a href="pages/manager/manager.jsp"&gt;后台管理&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div id=<span class="hljs-string">"main"</span>&gt;
    &lt;div id=<span class="hljs-string">"book"</span>&gt;
        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_cond"</span>&gt;
            &lt;form action=<span class="hljs-string">""</span> method=<span class="hljs-string">"get"</span>&gt;
                价格：&lt;input id=<span class="hljs-string">"min"</span> type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"min"</span> value=<span class="hljs-string">""</span>&gt; 元 -
                &lt;input id=<span class="hljs-string">"max"</span> type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"max"</span> value=<span class="hljs-string">""</span>&gt; 元
                &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"查询"</span>/&gt;
            &lt;/form&gt;
        &lt;/div&gt;
        &lt;div style=<span class="hljs-string">"text-align: center"</span>&gt;
            &lt;span&gt;您的购物车中有3件商品&lt;/span&gt;
            &lt;div&gt;
                您刚刚将&lt;span style="color: red"&gt;时间简史&lt;/span&gt;加入到了购物车中
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;c:forEach items=<span class="hljs-string">"$&#123;requestScope.page.items&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"book"</span>&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"b_list"</span>&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"img_div"</span>&gt;
                    &lt;img <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_img"</span> alt=<span class="hljs-string">""</span> src=<span class="hljs-string">"$&#123;book.imgPath&#125;"</span>/&gt;
                &lt;/div&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_info"</span>&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_name"</span>&gt;
                        &lt;span class="sp1"&gt;书名:&lt;/span&gt;
                        &lt;span class="sp2"&gt;$&#123;book.name&#125;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_author"</span>&gt;
                        &lt;span class="sp1"&gt;作者:&lt;/span&gt;
                        &lt;span class="sp2"&gt;$&#123;book.author&#125;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_price"</span>&gt;
                        &lt;span class="sp1"&gt;价格:￥&lt;/span&gt;
                        &lt;span class="sp2"&gt;$&#123;book.price&#125;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_sales"</span>&gt;
                        &lt;span class="sp1"&gt;销量:&lt;/span&gt;
                        &lt;span class="sp2"&gt;$&#123;book.sales&#125;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_amount"</span>&gt;
                        &lt;span class="sp1"&gt;库存:&lt;/span&gt;
                        &lt;span class="sp2"&gt;$&#123;book.stock&#125;&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_add"</span>&gt;
                        &lt;button&gt;加入购物车&lt;/button&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/c:forEach&gt;
    &lt;/div&gt;

    &lt;div id=<span class="hljs-string">"page_nav"</span>&gt;
        &lt;%-- 大于首页才显示--%&gt;
        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;1&#125;"</span>&gt;
            &lt;a href="client/clientBookServlet?action=page&amp;pageNo=1"&gt;首页&lt;/a&gt;
            &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageNo-1&#125;"&gt;上一页&lt;/a&gt;
        &lt;/c:if&gt;

        &lt;%--  页码输出的开始--%&gt;
        &lt;c:choose&gt;
            &lt;%-- 情况<span class="hljs-number">1</span>：如果总页码&lt;=<span class="hljs-number">5</span>,页码的范围是<span class="hljs-number">1</span>~总页码 --%&gt;
            &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&lt;=5&#125;"</span>&gt;
                &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                        【$&#123;i&#125;】
                    &lt;/c:if&gt;
                    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                        &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                    &lt;/c:if&gt;
                &lt;/c:forEach&gt;
            &lt;/c:when&gt;
            &lt;%--情况<span class="hljs-number">2</span>：总页码&gt;<span class="hljs-number">5</span> --%&gt;
            &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&gt;5&#125;"</span>&gt;
                &lt;c:choose&gt;
                    &lt;%-- 当前页码为前面<span class="hljs-number">3</span>个：页码范围是：<span class="hljs-number">1</span>~<span class="hljs-number">5</span>--%&gt;
                    &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;=3&#125;"</span>&gt;
                        &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"5"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                                【$&#123;i&#125;】
                            &lt;/c:if&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                                &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                            &lt;/c:if&gt;
                        &lt;/c:forEach&gt;
                    &lt;/c:when&gt;
                    &lt;%-- 当前页码为后面<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~末页--%&gt;
                    &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;=requestScope.page.pageTotal-2&#125;"</span>&gt;
                        &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-4&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                                【$&#123;i&#125;】
                            &lt;/c:if&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                                &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                            &lt;/c:if&gt;
                        &lt;/c:forEach&gt;
                    &lt;/c:when&gt;
                    &lt;%-- 当前页码为中间<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~当前页码+<span class="hljs-number">2</span>--%&gt;
                    &lt;c:otherwise&gt;
                        &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-2&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageNo+2&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                                【$&#123;i&#125;】
                            &lt;/c:if&gt;
                            &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                                &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                            &lt;/c:if&gt;
                        &lt;/c:forEach&gt;
                    &lt;/c:otherwise&gt;
                &lt;/c:choose&gt;
            &lt;/c:when&gt;
        &lt;/c:choose&gt;
        &lt;%--  页码输出的结束--%&gt;

        &lt;%--  小于末页才显示--%&gt;
        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;requestScope.page.pageTotal&#125;"</span>&gt;
            &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageNo+1&#125;"&gt;下一页&lt;/a&gt;
            &lt;a href="client/clientBookServlet?action=page&amp;pageNo=$&#123;requestScope.page.pageTotal&#125;"&gt;末页&lt;/a&gt;
        &lt;/c:if&gt;
        共$&#123;requestScope.page.pageTotal&#125;页，$&#123;requestScope.page.pageTotalCount&#125;条记录
        到第&lt;input value=<span class="hljs-string">"$&#123;param.pageNo&#125;"</span> name=<span class="hljs-string">"pn"</span> id=<span class="hljs-string">"pn_input"</span>/&gt;页
        &lt;input id=<span class="hljs-string">"searchPageBtn"</span>  type=<span class="hljs-string">"button"</span> value=<span class="hljs-string">"确定"</span>&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/footer.jsp"</span> %&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

<p><strong>抽取分页：</strong><br>在Page对象中添加url属性以及相应的get 和set方法：<br><img src="/2020/04/08/javaweb-02/32.png" srcset="/img/loading.gif" alt><br>分别在BookServlet和ClientBookServlet中设置url属性值：<br><img src="/2020/04/08/javaweb-02/33.png" srcset="/img/loading.gif" alt></p>
<p><img src="/2020/04/08/javaweb-02/34.png" srcset="/img/loading.gif" alt></p>
<p>分别将index.jsp和book_manager.jsp中出现的相应的地址值替换为<code>${requestScope.page.url}</code></p>
<p>在/pages/common/下创建page_nav.jsp用于提取分页代码：</p>
<pre><code class="hljs jsp">&lt;%@ taglib prefix=<span class="hljs-string">"c"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;
&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;
&lt;div id=<span class="hljs-string">"page_nav"</span>&gt;
    &lt;%-- 大于首页才显示--%&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;1&#125;"</span>&gt;
        &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=1"&gt;首页&lt;/a&gt;
        &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;requestScope.page.pageNo-1&#125;"&gt;上一页&lt;/a&gt;
    &lt;/c:if&gt;

    &lt;%--  页码输出的开始--%&gt;
    &lt;c:choose&gt;
        &lt;%-- 情况<span class="hljs-number">1</span>：如果总页码&lt;=<span class="hljs-number">5</span>,页码的范围是<span class="hljs-number">1</span>~总页码 --%&gt;
        &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&lt;=5&#125;"</span>&gt;
            &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                    【$&#123;i&#125;】
                &lt;/c:if&gt;
                &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                    &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                &lt;/c:if&gt;
            &lt;/c:forEach&gt;
        &lt;/c:when&gt;
        &lt;%--情况<span class="hljs-number">2</span>：总页码&gt;<span class="hljs-number">5</span> --%&gt;
        &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&gt;5&#125;"</span>&gt;
            &lt;c:choose&gt;
                &lt;%-- 当前页码为前面<span class="hljs-number">3</span>个：页码范围是：<span class="hljs-number">1</span>~<span class="hljs-number">5</span>--%&gt;
                &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;=3&#125;"</span>&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"1"</span> end=<span class="hljs-string">"5"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:when&gt;
                &lt;%-- 当前页码为后面<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~末页--%&gt;
                &lt;c:when test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&gt;=requestScope.page.pageTotal-2&#125;"</span>&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-4&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageTotal&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:when&gt;
                &lt;%-- 当前页码为中间<span class="hljs-number">3</span>个：页码范围是：当前页码-<span class="hljs-number">2</span>~当前页码+<span class="hljs-number">2</span>--%&gt;
                &lt;c:otherwise&gt;
                    &lt;c:forEach begin=<span class="hljs-string">"$&#123;requestScope.page.pageNo-2&#125;"</span> end=<span class="hljs-string">"$&#123;requestScope.page.pageNo+2&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"i"</span>&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo==i&#125;"</span>&gt;
                            【$&#123;i&#125;】
                        &lt;/c:if&gt;
                        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo!=i&#125;"</span>&gt;
                            &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;i&#125;"&gt;$&#123;i&#125;&lt;/a&gt;
                        &lt;/c:if&gt;
                    &lt;/c:forEach&gt;
                &lt;/c:otherwise&gt;
            &lt;/c:choose&gt;
        &lt;/c:when&gt;
    &lt;/c:choose&gt;
    &lt;%--  页码输出的结束--%&gt;

    &lt;%--  小于末页才显示--%&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;requestScope.page.pageNo&lt;requestScope.page.pageTotal&#125;"</span>&gt;
        &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;requestScope.page.pageNo+1&#125;"&gt;下一页&lt;/a&gt;
        &lt;a href="$&#123;requestScope.page.url&#125;&amp;pageNo=$&#123;requestScope.page.pageTotal&#125;"&gt;末页&lt;/a&gt;
    &lt;/c:if&gt;
    共$&#123;requestScope.page.pageTotal&#125;页，$&#123;requestScope.page.pageTotalCount&#125;条记录
    到第&lt;input value=<span class="hljs-string">"$&#123;param.pageNo&#125;"</span> name=<span class="hljs-string">"pn"</span> id=<span class="hljs-string">"pn_input"</span>/&gt;页
    &lt;input id=<span class="hljs-string">"searchPageBtn"</span> type=<span class="hljs-string">"button"</span> value=<span class="hljs-string">"确定"</span>&gt;
&lt;/div&gt;</code></pre>

<p>在index.jsp和book_mansger.jsp中的分页代码替换成静态包含代码：</p>
<pre><code class="hljs jsp">&lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/page_nav.jsp"</span>%&gt;</code></pre>

<h4 id="6、实现价格区间的搜索功能："><a href="#6、实现价格区间的搜索功能：" class="headerlink" title="6、实现价格区间的搜索功能："></a>6、实现价格区间的搜索功能：</h4><p><img src="/2020/04/08/javaweb-02/35.png" srcset="/img/loading.gif" alt></p>
<p><strong>在ClientBookClient中添加pageByPrice()方法用于处理搜索请求：</strong></p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pageByPrice</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// 1.获取请求参数 pageNo,pageSize,min,max</span>
    <span class="hljs-keyword">int</span> pageNo = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageNo"</span>),<span class="hljs-number">1</span>);
    <span class="hljs-keyword">int</span> pageSize = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"pageSize"</span>),Page.PAGE_SIZE);
    <span class="hljs-keyword">int</span> min = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"min"</span>),<span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> max = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"max"</span>),Integer.MAX_VALUE);
    <span class="hljs-comment">// 2.调用bookService.pageByPrice(pageNo,pageSize,min,max) 返回page对象</span>
    Page&lt;Book&gt; page = bookService.pageByPrice(pageNo,pageSize,min,max);
    <span class="hljs-comment">//设置请求地址 分页时需要传递价格区间</span>
    StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"client/clientBookServlet?action=pageByPrice"</span>);
    <span class="hljs-comment">// 对价格区间进行检查</span>
    <span class="hljs-keyword">if</span>(req.getParameter(<span class="hljs-string">"min"</span>)!=<span class="hljs-keyword">null</span>)&#123;
        stringBuilder.append(<span class="hljs-string">"&amp;min="</span>).append(req.getParameter(<span class="hljs-string">"min"</span>));
    &#125;
    <span class="hljs-keyword">if</span>(req.getParameter(<span class="hljs-string">"max"</span>)!=<span class="hljs-keyword">null</span>)&#123;
        stringBuilder.append(<span class="hljs-string">"&amp;max="</span>).append(req.getParameter(<span class="hljs-string">"max"</span>));
    &#125;
    page.setUrl(stringBuilder.toString());

    <span class="hljs-comment">// 3.将Page对象保存到Request域中</span>
    req.setAttribute(<span class="hljs-string">"page"</span>,page);
    <span class="hljs-comment">// 4.请求转发到</span>
    req.getRequestDispatcher(<span class="hljs-string">"/pages/client/index.jsp"</span>).forward(req,resp);
&#125;</code></pre>

<p><strong>在BookService中添加pageByPrice(pageNo,pageSize,min,max)方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 根据价格区间获取page对象</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageNo</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageSize</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> min</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> max</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function">Page&lt;Book&gt; <span class="hljs-title">pageByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNo, <span class="hljs-keyword">int</span> pageSize, <span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span></span>;</code></pre>

<p><strong>在BookServiceImpl中实现pageByPrice(pageNo,pageSize,min,max)方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Page&lt;Book&gt; <span class="hljs-title">pageByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNo, <span class="hljs-keyword">int</span> pageSize, <span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span> </span>&#123;
    Page&lt;Book&gt; bookPage = <span class="hljs-keyword">new</span> Page&lt;&gt;();

    <span class="hljs-comment">//设置每页显示的数量</span>
    bookPage.setPageSize(pageSize);
    <span class="hljs-comment">// 设置总记录数</span>
    Integer pageTotalCount = bookDao.queryForPageTotalCountByPrice(min,max);
    bookPage.setPageTotalCount(pageTotalCount);
    <span class="hljs-comment">// 设置总页码</span>
    Integer pageTotal = pageTotalCount/pageSize;
    <span class="hljs-keyword">if</span> (pageTotalCount % pageSize&gt;<span class="hljs-number">0</span>)&#123;
        pageTotal++;
    &#125;
    bookPage.setPageTotal(pageTotal);
    <span class="hljs-comment">// 设置当前页码</span>
    bookPage.setPageNo(pageNo);
    <span class="hljs-comment">// 设置当页数据</span>
    <span class="hljs-keyword">int</span> begin = (bookPage.getPageNo()-<span class="hljs-number">1</span>)*pageSize;
    bookPage.setItems(bookDao.queryForItemsByPrice(begin,pageSize,min,max));
    <span class="hljs-keyword">return</span> bookPage;
&#125;</code></pre>

<p><strong>在BookDao中添加queryForPageTotalCountByPrice(int min, int max)和queryForItemsByPrice(int begin, int pageSize, int min, int max)方法：</strong></p>
<pre><code class="hljs java"> <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据价格区间查询总记录数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> min</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> max</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function">Integer <span class="hljs-title">queryForPageTotalCountByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据价格区间查询所有记录</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageSize</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> min</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> max</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function">List&lt;Book&gt; <span class="hljs-title">queryForItemsByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> begin, <span class="hljs-keyword">int</span> pageSize, <span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span></span>;
&#125;</code></pre>

<p><strong>在BookDaoImpl中实现这两种方法：</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">queryForPageTotalCountByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span> </span>&#123;
    String sql = <span class="hljs-string">"select count(*) from book where price between ? and ?"</span>;
    Number count = (Number) queryForSingleValue(sql,min,max);
    <span class="hljs-keyword">return</span>  count.intValue();
&#125;

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title">queryForItemsByPrice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> begin, <span class="hljs-keyword">int</span> pageSize, <span class="hljs-keyword">int</span> min, <span class="hljs-keyword">int</span> max)</span> </span>&#123;
    String sql = <span class="hljs-string">" select `id`, `name`,`author`,`price`,`sales`,`stock`,`img_path` imgPath from book"</span> +
            <span class="hljs-string">" where price between ? and ? order by price limit ?,?"</span>;
    <span class="hljs-keyword">return</span> queryForList(Book<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>,<span class="hljs-title">min</span>,<span class="hljs-title">max</span>,<span class="hljs-title">begin</span>,<span class="hljs-title">pageSize</span>)</span>;
&#125;</code></pre>

<p><strong>修改index.jsp向服务器提交搜索请求：</strong></p>
<pre><code class="hljs jsp">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_cond"</span>&gt;
        &lt;form action=<span class="hljs-string">"client/clientBookServlet"</span> method=<span class="hljs-string">"get"</span>&gt;
            &lt;input type=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"action"</span> value=<span class="hljs-string">"pageByPrice"</span>/&gt;
            价格：&lt;input id=<span class="hljs-string">"min"</span> type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"min"</span> value=<span class="hljs-string">"$&#123;param.min&#125;"</span>&gt; 元 -
            &lt;input id=<span class="hljs-string">"max"</span> type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"max"</span> value=<span class="hljs-string">"$&#123;param.max&#125;"</span>&gt; 元
            &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"查询"</span>/&gt;
        &lt;/form&gt;
&lt;/div&gt;</code></pre>

<h2 id="十一、保存用户登录之后的信息"><a href="#十一、保存用户登录之后的信息" class="headerlink" title="十一、保存用户登录之后的信息"></a>十一、保存用户登录之后的信息</h2><p>在UserServlet添加保存用户登录信息到Session域中的代码：<br><img src="/2020/04/08/javaweb-02/36.png" srcset="/img/loading.gif" alt></p>
<p>在login_success_menu.jsp中 显示用户姓名：<br><img src="/2020/04/08/javaweb-02/37.png" srcset="/img/loading.gif" alt></p>
<p>修改index.jsp的菜单显示：</p>
<pre><code class="hljs jsp">&lt;div&gt;
     &lt;%--  如果用户还没有登录，显示登录和注册菜单 --%&gt;
     &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;empty sessionScope.user&#125;"</span>&gt;
      	&lt;a href="pages/user/login.jsp"&gt;登录&lt;/a&gt;/
         &lt;a href="pages/user/regist.jsp"&gt;注册&lt;/a&gt;
     &lt;/c:if&gt;

     &lt;%--  如果用户已经登录，则显示登录成功之后用户的信息 --%&gt;
     &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;not empty sessionScope.user&#125;"</span>&gt;
         &lt;span&gt;欢迎&lt;span class="um_span"&gt;$&#123;sessionScope.user.username&#125;&lt;/span&gt;光临书城&lt;/span&gt;
         &lt;a href="pages/order/order.jsp"&gt;我的订单&lt;/a&gt;
         &lt;a href="pages/cart/cart.jsp"&gt;购物车&lt;/a&gt;
         &lt;a href="pages/manager/manager.jsp"&gt;后台管理&lt;/a&gt;
         &lt;a href="index.jsp"&gt;注销&lt;/a&gt;&amp;nbsp;
     &lt;/c:if&gt;
&lt;/div&gt;</code></pre>

<p><strong><font color="red">注意：</font></strong><br>固定相对路径跳转使用的地址必须是相对路径，否则在进行跳转时Tomcat会创建一个新的Session，造成Session会话信息丢失！<br><img src="/2020/04/08/javaweb-02/38.png" srcset="/img/loading.gif" alt></p>
<h2 id="十二、注销登录"><a href="#十二、注销登录" class="headerlink" title="十二、注销登录"></a>十二、注销登录</h2><p>在userServlet中添加logout()方法用于处理注销请求：</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">logout</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// 1.销毁 Session</span>
    req.getSession().invalidate();
    <span class="hljs-comment">// 2.重定向到首页</span>
    resp.sendRedirect(req.getContextPath());
&#125;</code></pre>

<p>修改jsp页面的跳转地址：<br><img src="/2020/04/08/javaweb-02/39.png" srcset="/img/loading.gif" alt></p>
<h2 id="十三、使用验证码解决表单的重复提交"><a href="#十三、使用验证码解决表单的重复提交" class="headerlink" title="十三、使用验证码解决表单的重复提交"></a>十三、使用验证码解决表单的重复提交</h2><p>表单重复提交有三种常见的情况：<br>一：提交完表单。服务器使用请求转来进行页面跳转。这个时候，用户按下功能键F5，就会发起最后一次的请求。造成表单重复提交问题。解决方法：使用重定向来进行跳转。<br>二：用户正常提交服务器，但是由于网络延迟等原因，迟迟未收到服务器的响应，这个时候，用户以为提交失败，<br>就会着急，然后多点了几次提交操作，也会造成表单重复提交。<br>三：用户正常提交服务器。服务器也没有延迟，但是提交完成后，用户回退浏览器。重新提交。也会造成表单重复<br>提交。<br><img src="/2020/04/08/javaweb-02/40.png" srcset="/img/loading.gif" alt></p>
<p>1.导入谷歌验证码的jar包：kaptcha-2.3.2.jar<br>2.在web.xml中配置用于访问生成验证码的Servlet程序的地址</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>KaptchaServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.google.code.kaptcha.servlet.KaptchaServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>KaptchaServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/kaptcha.jpg<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span></code></pre>

<p>3.在表单中使用img标签显示验证码图片</p>
<pre><code class="hljs jsp">&lt;label&gt;验证码：&lt;/label&gt;
&lt;input <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"itxt"</span> type=<span class="hljs-string">"text"</span> style=<span class="hljs-string">"width: 150px;"</span> name=<span class="hljs-string">"code"</span> id=<span class="hljs-string">"code"</span>/&gt;
&lt;img id=<span class="hljs-string">"code_img"</span> alt=<span class="hljs-string">""</span> src=<span class="hljs-string">"kaptcha.jpg"</span> style=<span class="hljs-string">"float: right; height: 40px; width:120px"</span>&gt;
&lt;br/&gt;
&lt;span style="float: right;font-size: 80%"&gt;看不清？点击图片刷新&lt;/span&gt;
&lt;br/&gt;</code></pre>

<p>4.在服务端中获取生成的验证码并于与客户端发送过来的验证码比较<br><img src="/2020/04/08/javaweb-02/41.png" srcset="/img/loading.gif" alt></p>
<p>5.给验证码图片绑定单击事件用于刷新验证码：</p>
<pre><code class="hljs javascript"><span class="hljs-comment">// 给验证码图片绑定单击事件</span>
$(<span class="hljs-string">"#code_img"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
	<span class="hljs-comment">// 添加一个随机数避免请求地址相同，因为浏览器缓存造成不刷新</span>
	<span class="hljs-keyword">this</span>.src = <span class="hljs-string">"$&#123;basePath&#125;kaptcha.jpg?n="</span>+ <span class="hljs-built_in">Math</span>.random();
&#125;);</code></pre>

<h2 id="十四、购物车模块"><a href="#十四、购物车模块" class="headerlink" title="十四、购物车模块"></a>十四、购物车模块</h2><p><img src="/2020/04/08/javaweb-02/42.png" srcset="/img/loading.gif" alt></p>
<h3 id="1、创建购物车对象"><a href="#1、创建购物车对象" class="headerlink" title="1、创建购物车对象"></a>1、创建购物车对象</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cart</span> </span>&#123;
    <span class="hljs-comment">// private Integer totalCount;// 商品总数</span>
    <span class="hljs-comment">// private BigDecimal totalPrice;// 总商品金额</span>
    <span class="hljs-keyword">private</span> Map&lt;Integer, CartItem&gt; items = <span class="hljs-keyword">new</span> LinkedHashMap&lt;Integer, CartItem&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getTotalCount</span><span class="hljs-params">()</span> </span>&#123;
        Integer totalCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, CartItem&gt; entry : items.entrySet()) &#123;
            totalCount += entry.getValue().getCount();
        &#125;
        <span class="hljs-keyword">return</span> totalCount;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getTotalPrice</span><span class="hljs-params">()</span> </span>&#123;
        BigDecimal totalPrice = <span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, CartItem&gt; entry : items.entrySet()) &#123;
            totalPrice = totalPrice.add(entry.getValue().getTotalPrice());
        &#125;
        <span class="hljs-keyword">return</span> totalPrice;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;Integer, CartItem&gt; <span class="hljs-title">getItems</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> items;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setItems</span><span class="hljs-params">(Map&lt;Integer, CartItem&gt; items)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.items = items;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Cart&#123;"</span> +
                <span class="hljs-string">"totalCount="</span> + getTotalCount() +
                <span class="hljs-string">", totalPrice="</span> + getTotalPrice() +
                <span class="hljs-string">", items="</span> + items +
                <span class="hljs-string">'&#125;'</span>;
    &#125;

    <span class="hljs-comment">// 添加商品项</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addItem</span><span class="hljs-params">(CartItem cartItem)</span> </span>&#123;
        <span class="hljs-comment">// 判断商品是否已经添加</span>
        CartItem item = items.get(cartItem.getId());
        <span class="hljs-keyword">if</span> (item == <span class="hljs-keyword">null</span>) &#123;
            items.put(cartItem.getId(), cartItem);
        &#125; <span class="hljs-keyword">else</span> &#123;
            item.setCount(item.getCount() + <span class="hljs-number">1</span>);
            item.setTotalPrice(item.getPrice().multiply(<span class="hljs-keyword">new</span> BigDecimal(item.getCount())));
        &#125;
    &#125;

    <span class="hljs-comment">// 删除商品项</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteItem</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        items.remove(id);
    &#125;

    <span class="hljs-comment">// 清空购物车</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clean</span><span class="hljs-params">()</span> </span>&#123;
        items.clear();
    &#125;

    <span class="hljs-comment">// 修改商品数量</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateCount</span><span class="hljs-params">(Integer id, Integer count)</span> </span>&#123;
        CartItem item = items.get(id);
        <span class="hljs-keyword">if</span> (item != <span class="hljs-keyword">null</span>) &#123;
            item.setCount(count);
            item.setTotalPrice(item.getPrice().multiply(<span class="hljs-keyword">new</span> BigDecimal(item.getCount())));
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="2、创建购物车商品项"><a href="#2、创建购物车商品项" class="headerlink" title="2、创建购物车商品项"></a>2、创建购物车商品项</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartItem</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer count; <span class="hljs-comment">// 数量</span>
    <span class="hljs-keyword">private</span> BigDecimal price; <span class="hljs-comment">// 单价</span>
    <span class="hljs-keyword">private</span> BigDecimal totalPrice;<span class="hljs-comment">// 商品总价</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CartItem</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CartItem</span><span class="hljs-params">(Integer id, String name, Integer count, BigDecimal price, BigDecimal totalPrice)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.count = count;
        <span class="hljs-keyword">this</span>.price = price;
        <span class="hljs-keyword">this</span>.totalPrice = totalPrice;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.name = name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> count;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCount</span><span class="hljs-params">(Integer count)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.count = count;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPrice</span><span class="hljs-params">(BigDecimal price)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.price = price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getTotalPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> totalPrice;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotalPrice</span><span class="hljs-params">(BigDecimal totalPrice)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.totalPrice = totalPrice;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"CartItem&#123;"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", count="</span> + count +
                <span class="hljs-string">", price="</span> + price +
                <span class="hljs-string">", totalPrice="</span> + totalPrice +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<h3 id="3、CartServlet用于处理商品的添加、删除、清空和修改数量"><a href="#3、CartServlet用于处理商品的添加、删除、清空和修改数量" class="headerlink" title="3、CartServlet用于处理商品的添加、删除、清空和修改数量"></a>3、CartServlet用于处理商品的添加、删除、清空和修改数量</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseServlet</span> </span>&#123;
    <span class="hljs-keyword">private</span> BookService bookService = <span class="hljs-keyword">new</span> BookServiceImpl();
    
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addItem</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// System.out.println("加入购物车");</span>
        <span class="hljs-comment">// 获取请求参数  商品编号</span>
        <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
        <span class="hljs-comment">// 调用bookService.queryBookById(id) 得到图书信息</span>
        Book book = bookService.queryBookById(id);
        <span class="hljs-comment">// 将图书信息转换位CartItem商品项</span>
        CartItem cartItem = <span class="hljs-keyword">new</span> CartItem(book.getId(),book.getName(),<span class="hljs-number">1</span>,book.getPrice(),book.getPrice());
        <span class="hljs-comment">// 调用cart.add(CartItem)添加至购物车</span>
        Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
        <span class="hljs-keyword">if</span>(cart == <span class="hljs-keyword">null</span>)&#123;
            cart = <span class="hljs-keyword">new</span> Cart();
            req.getSession().setAttribute(<span class="hljs-string">"cart"</span>,cart);
        &#125;
        cart.addItem(cartItem);
        <span class="hljs-comment">// System.out.println(cart);</span>
        <span class="hljs-comment">// 重定向到原来商品所在的页面</span>
        resp.sendRedirect(req.getHeader(<span class="hljs-string">"Referer"</span>));
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteItem</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取请求参数 id</span>
        <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
        <span class="hljs-comment">// 调用cart.deleteItem(id)</span>
        Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
        <span class="hljs-keyword">if</span>(cart != <span class="hljs-keyword">null</span>)&#123;
            cart.deleteItem(id);
        &#125;
       resp.sendRedirect(req.getHeader(<span class="hljs-string">"Referer"</span>));
    &#125;
    
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取购物车对象</span>
        Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
        <span class="hljs-comment">// 调用cart.clear()</span>
        <span class="hljs-keyword">if</span>(cart!=<span class="hljs-keyword">null</span>)&#123;
            cart.clear();
        &#125;
        resp.sendRedirect(req.getHeader(<span class="hljs-string">"Referer"</span>));
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateCount</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取请求的参数  商品编号  商品数量</span>
        <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
        <span class="hljs-keyword">int</span> count = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"count"</span>), <span class="hljs-number">1</span>);
        <span class="hljs-comment">// 获取Cart对象</span>
        Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
        <span class="hljs-keyword">if</span>(cart!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">// 调用updateCount方法</span>
            cart.updateCount(id,count);
        &#125;
        resp.sendRedirect(req.getHeader(<span class="hljs-string">"Referer"</span>));
    &#125;
&#125;</code></pre>

<h3 id="4、购物车页面的展示"><a href="#4、购物车页面的展示" class="headerlink" title="4、购物车页面的展示"></a>4、购物车页面的展示</h3><pre><code class="hljs jsp">&lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
    $(function () &#123;
        <span class="hljs-comment">// 给删除商品绑定单击事件</span>
        $(<span class="hljs-string">"a.deleteItem"</span>).click(function () &#123;
            <span class="hljs-keyword">return</span> confirm(<span class="hljs-string">"确定从购物车中删除《"</span>+$(<span class="hljs-keyword">this</span>).parent().parent().find(<span class="hljs-string">"td:first"</span>).text()+<span class="hljs-string">"》吗？"</span>)
        &#125;);
        <span class="hljs-comment">// 给清空购物车绑定单击事件</span>
        $(<span class="hljs-string">"#clearCart"</span>).click(function()&#123;
           <span class="hljs-keyword">return</span>  confirm(<span class="hljs-string">"确定清空购物车？"</span>);
        &#125;);
        <span class="hljs-comment">// 给修改商品数量绑定失去焦点事件  --- onchange事件判断内容是否改变</span>
        $(<span class="hljs-string">".updateCount"</span>).change(function()&#123;
            <span class="hljs-keyword">var</span> id = $(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">"bookId"</span>);
            <span class="hljs-keyword">var</span> count = <span class="hljs-keyword">this</span>.value;
            <span class="hljs-keyword">if</span>(confirm(<span class="hljs-string">"确定修改商品的数量为 "</span>+count+<span class="hljs-string">" 吗？"</span>)&amp;&amp;count&gt;<span class="hljs-number">0</span>)&#123;
                location.href=<span class="hljs-string">"$&#123;PageScope.basePath&#125;cartServlet?action=updateCount&amp;count="</span>+count+<span class="hljs-string">"&amp;id="</span>+id;
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">this</span>.value = <span class="hljs-keyword">this</span>.defaultValue;<span class="hljs-comment">// 恢复到原来的数据</span>
            &#125;
        &#125;);
    &#125;)
&lt;/script&gt;
&lt;body&gt;
&lt;div id=<span class="hljs-string">"header"</span>&gt;
    &lt;span class="wel_word"&gt;购物车&lt;/span&gt;
        &lt;%--   静态包含，登录成功之后的菜单    --%&gt;
        &lt;%<span class="hljs-meta">@include</span> file=<span class="hljs-string">"/pages/common/login_sucess_menu.jsp"</span> %&gt;
&lt;/div&gt;
&lt;div id=<span class="hljs-string">"main"</span>&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;商品名称&lt;/td&gt;
            &lt;td&gt;数量&lt;/td&gt;
            &lt;td&gt;单价&lt;/td&gt;
            &lt;td&gt;金额&lt;/td&gt;
            &lt;td&gt;操作&lt;/td&gt;
        &lt;/tr&gt;
        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;empty sessionScope.cart.items&#125;"</span>&gt;
            &lt;tr&gt;
                &lt;td colspan="5"&gt;&lt;a href="index.jsp"&gt;当前购物车为空！点击浏览商品&lt;/a&gt;&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/c:if&gt;

        &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;not empty sessionScope.cart.items&#125;"</span>&gt;
            &lt;%-- 购物车非空才输出--%&gt;
            &lt;c:forEach items=<span class="hljs-string">"$&#123;sessionScope.cart.items&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"entry"</span>&gt;
                &lt;tr&gt;
                    &lt;td&gt;$&#123;entry.value.name&#125;&lt;/td&gt;
                    &lt;td&gt;
                         &lt;input <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"updateCount"</span>
                                style=<span class="hljs-string">"width: 80px;text-align: center"</span>
                                bookId=<span class="hljs-string">"$&#123;entry.value.id&#125;"</span>
                                type=<span class="hljs-string">"number"</span> value=<span class="hljs-string">"$&#123;entry.value.count&#125;"</span>&gt;
                    &lt;/td&gt;
                    &lt;td&gt;$&#123;entry.value.price&#125;&lt;/td&gt;
                    &lt;td&gt;$&#123;entry.value.totalPrice&#125;&lt;/td&gt;
                    &lt;td&gt;&lt;a class="deleteItem" href="cartServlet?action=deleteItem&amp;id=$&#123;entry.value.id&#125;"&gt;删除&lt;/a&gt;&lt;/td&gt;
                &lt;/tr&gt;
            &lt;/c:forEach&gt;
        &lt;/c:if&gt;
    &lt;/table&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;not empty sessionScope.cart.items&#125;"</span>&gt;
        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"cart_info"</span>&gt;
            &lt;span class="cart_span"&gt;购物车中共有&lt;span class="b_count"&gt;$&#123;sessionScope.cart.totalCount&#125;&lt;/span&gt;件商品&lt;/span&gt;
            &lt;span class="cart_span"&gt;总金额&lt;span class="b_price"&gt;$&#123;sessionScope.cart.totalPrice&#125;&lt;/span&gt;元&lt;/span&gt;
            &lt;span class="cart_span"&gt;&lt;a id="clearCart" href="cartServlet?action=clear"&gt;清空购物车&lt;/a&gt;&lt;/span&gt;
            &lt;span class="cart_span"&gt;&lt;a href="pages/cart/checkout"&gt;去结账&lt;/a&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/c:if&gt;
&lt;/div&gt;</code></pre>

<h3 id="5、修改首页"><a href="#5、修改首页" class="headerlink" title="5、修改首页"></a>5、修改首页</h3><pre><code class="hljs javascript"><span class="hljs-comment">// 添加到购物车</span>
$(<span class="hljs-string">"button.addToCart"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 在事件响应的function函数中  this表示正在响应的dom对象  $(this)表示经过jquery封装后的dom对象</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@type <span class="hljs-type">&#123;jQuery&#125;</span></span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-comment">// 判断用户是否登录</span>
    <span class="hljs-keyword">if</span>($&#123;sessionScope.user == <span class="hljs-literal">null</span>&#125;)&#123;
        alert(<span class="hljs-string">"您还没有登录，请先登录或注册！"</span>)
        location.href =<span class="hljs-string">"$&#123;pageScope.basePath&#125;pages/user/login.jsp"</span>;
    &#125; <span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">var</span> bookid =$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">"bookid"</span>);<span class="hljs-comment">// 获取选中元素的属性值</span>
        location.href=<span class="hljs-string">"$&#123;pageScope.basePath&#125;cartServlet?action=addItem&amp;id="</span>+bookid;
    &#125;
   &#125;);</code></pre>

<pre><code class="hljs jsp">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"book_add"</span>&gt;
    &lt;button bookid="$&#123;book.id&#125;" class="addToCart"&gt;加入购物车&lt;/button&gt;
&lt;/div&gt;</code></pre>

<h3 id="6、首页购物车数据回显"><a href="#6、首页购物车数据回显" class="headerlink" title="6、首页购物车数据回显"></a>6、首页购物车数据回显</h3><p>在addItem()中将添加的图书信息保存到session域中：<br><img src="/2020/04/08/javaweb-02/43.png" srcset="/img/loading.gif" alt></p>
<p>在首页显示需要的信息：</p>
<pre><code class="hljs jsp">&lt;span&gt;您的购物车中有&lt;span style="color: blue"&gt;$&#123;sessionScope.cart.totalCount&#125;&lt;/span&gt;件商品&lt;/span&gt;
&lt;span&gt;
   &lt;%--  购物车为空--%&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;empty sessionScope.cart.items&#125;"</span>&gt;
        &lt;span style="color: red"&gt;当前购物车为空~&lt;/span&gt;
    &lt;/c:if&gt;
    &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;not empty sessionScope.cart.items&#125;"</span>&gt;
           您刚刚将&lt;span style="color: red"&gt;$&#123;sessionScope.itemName&#125;&lt;/span&gt;加入到了购物车中
     &lt;/c:if&gt;
&lt;/span&gt;</code></pre>

<h2 id="十五、订单模块"><a href="#十五、订单模块" class="headerlink" title="十五、订单模块"></a>十五、订单模块</h2><p><img src="/2020/04/08/javaweb-02/44.png" srcset="/img/loading.gif" alt></p>
<h3 id="1、创建Order-与OrderItem对象"><a href="#1、创建Order-与OrderItem对象" class="headerlink" title="1、创建Order 与OrderItem对象"></a>1、创建Order 与OrderItem对象</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span> </span>&#123;
    <span class="hljs-keyword">private</span> String orderId;<span class="hljs-comment">// 订单号</span>
    <span class="hljs-keyword">private</span> Date createTime;<span class="hljs-comment">// 下单时间</span>
    <span class="hljs-keyword">private</span> BigDecimal price;<span class="hljs-comment">// 订单价格</span>
    <span class="hljs-keyword">private</span> Integer status = <span class="hljs-number">0</span>;<span class="hljs-comment">// 0 未发货  1 已发货 2 已签收</span>
    <span class="hljs-keyword">private</span> Integer userId;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Order</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Order</span><span class="hljs-params">(String orderId, Date createTime, BigDecimal price, Integer status, Integer userId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.orderId = orderId;
        <span class="hljs-keyword">this</span>.createTime = createTime;
        <span class="hljs-keyword">this</span>.price = price;
        <span class="hljs-keyword">this</span>.status = status;
        <span class="hljs-keyword">this</span>.userId = userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOrderId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOrderId</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.orderId = orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.createTime = createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPrice</span><span class="hljs-params">(BigDecimal price)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.price = price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> status;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(Integer status)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.status = status;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(Integer userId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.userId = userId;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Order&#123;"</span> +
                <span class="hljs-string">"orderId="</span> + orderId +
                <span class="hljs-string">", createTime="</span> + createTime +
                <span class="hljs-string">", price="</span> + price +
                <span class="hljs-string">", status="</span> + status +
                <span class="hljs-string">", userId="</span> + userId +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderItem</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;<span class="hljs-comment">// 商品编号</span>
    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">// 商品名称</span>
    <span class="hljs-keyword">private</span> Integer count;<span class="hljs-comment">// 商品数量</span>
    <span class="hljs-keyword">private</span> BigDecimal price;<span class="hljs-comment">// 商品总价格</span>
    <span class="hljs-keyword">private</span> BigDecimal totalPrice;<span class="hljs-comment">// 商品总价格</span>
    <span class="hljs-keyword">private</span> String orderId;<span class="hljs-comment">// 订单号</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrderItem</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrderItem</span><span class="hljs-params">(Integer id, String name, Integer count, BigDecimal price, BigDecimal totalPrice, String orderId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.count = count;
        <span class="hljs-keyword">this</span>.price = price;
        <span class="hljs-keyword">this</span>.totalPrice = totalPrice;
        <span class="hljs-keyword">this</span>.orderId = orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.name = name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> count;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCount</span><span class="hljs-params">(Integer count)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.count = count;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getTotalPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> totalPrice;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotalPrice</span><span class="hljs-params">(BigDecimal totalPrice)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.totalPrice = totalPrice;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOrderId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOrderId</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.orderId = orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">getPrice</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> price;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPrice</span><span class="hljs-params">(BigDecimal price)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.price = price;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"OrderItem&#123;"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", count="</span> + count +
                <span class="hljs-string">", price="</span> + price +
                <span class="hljs-string">", totalPrice="</span> + totalPrice +
                <span class="hljs-string">", orderId="</span> + orderId +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre>

<h3 id="2、创建OrderDao接口并实现接口中的方法"><a href="#2、创建OrderDao接口并实现接口中的方法" class="headerlink" title="2、创建OrderDao接口并实现接口中的方法"></a>2、创建OrderDao接口并实现接口中的方法</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderDao</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 保存订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> order</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveOrder</span><span class="hljs-params">(Order order)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询全部订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">queryOrders</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 修改订单状态</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> Status</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">changeOrderStatus</span><span class="hljs-params">(String orderId,Integer status)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据用户编号查看订单信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> UserId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">queryOrderByUserId</span><span class="hljs-params">(Integer userId)</span></span>;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderDao</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveOrder</span><span class="hljs-params">(Order order)</span> </span>&#123;
        String sql = <span class="hljs-string">"insert into bookorder(`order_id`,`create_time`,`price`,`status`,`user_id`)values(?,?,?,?,?)"</span>;
        <span class="hljs-keyword">return</span> update(sql,order.getOrderId(),order.getCreateTime(),order.getPrice(),order.getStatus(),order.getUserId());
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">queryOrders</span><span class="hljs-params">()</span> </span>&#123;
        String sql = <span class="hljs-string">"select `order_id` orderId ,`create_time` createTime,`price` ,`status`,`user_id` userId from bookorder"</span>;
        <span class="hljs-keyword">return</span> queryForList(Order<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>)</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">changeOrderStatus</span><span class="hljs-params">(String orderId, Integer status)</span> </span>&#123;
        String sql = <span class="hljs-string">"update bookorder set status = ? where order_id = ?"</span>;
        <span class="hljs-keyword">return</span> update(sql,status,orderId);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">queryOrderByUserId</span><span class="hljs-params">(Integer userId)</span> </span>&#123;
        String sql = <span class="hljs-string">"select `order_id` orderId ,`create_time` createTime,`price` ,`status`,`user_id` userId from bookorder where user_id=?"</span>;
        <span class="hljs-keyword">return</span> queryForList(Order<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>,<span class="hljs-title">userId</span>)</span>;
    &#125;
&#125;</code></pre>

<h3 id="3、创建-OrderItemDao接口并实现其方法"><a href="#3、创建-OrderItemDao接口并实现其方法" class="headerlink" title="3、创建 OrderItemDao接口并实现其方法"></a>3、创建 OrderItemDao接口并实现其方法</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderItemDao</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 保存订单项</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> item</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveOrderItem</span><span class="hljs-params">(OrderItem item)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 更具订单号查询订单详情</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderItem <span class="hljs-title">queryOrderItemsByOrderId</span><span class="hljs-params">(String orderId)</span></span>;
&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderItemDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderItemDao</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">saveOrderItem</span><span class="hljs-params">(OrderItem item)</span> </span>&#123;
        String sql = <span class="hljs-string">"insert into bookorder_item(`name`,`count`,`price`,`totalprice`,`order_id`)values(?,?,?,?,?)"</span>;
        <span class="hljs-keyword">return</span> update(sql,item.getName(),item.getCount(),item.getPrice(),item.getTotalPrice(),item.getOrderId());
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderItem <span class="hljs-title">queryOrderItemsByOrderId</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        String sql = <span class="hljs-string">"select `name`,`count`,`price`,`totalprice` totalPrice,`order_id` orderId from bookorder_item where order_id = ?"</span>;
        <span class="hljs-keyword">return</span> queryForOne(OrderItem<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">sql</span>,<span class="hljs-title">orderId</span>)</span>;
    &#125;
&#125;</code></pre>

<h3 id="4、创建OrderService并实现其中的方法"><a href="#4、创建OrderService并实现其中的方法" class="headerlink" title="4、创建OrderService并实现其中的方法"></a>4、创建OrderService并实现其中的方法</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderService</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 生成订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cart</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 订单号</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createOrder</span><span class="hljs-params">(Cart cart,Integer userId)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询全部订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">showAllOrder</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发货</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String orderId)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查看订单详情</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderItem <span class="hljs-title">showOrderDetailById</span><span class="hljs-params">(String orderId)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户查看订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">showMyOrder</span><span class="hljs-params">(Integer userId)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 签收订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiverOrder</span><span class="hljs-params">(String orderId)</span></span>;

&#125;</code></pre>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderService</span> </span>&#123;

    <span class="hljs-keyword">private</span> OrderDao orderDao = <span class="hljs-keyword">new</span> OrderDaoImpl();
    <span class="hljs-keyword">private</span> OrderItemDao orderItemDao = <span class="hljs-keyword">new</span> OrderItemDaoImpl();
    <span class="hljs-keyword">private</span> BookDao bookDao = <span class="hljs-keyword">new</span> BookDaoImpl();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createOrder</span><span class="hljs-params">(Cart cart, Integer userId)</span> </span>&#123;
        <span class="hljs-comment">// 订单号唯一</span>
        String orderId = System.currentTimeMillis() + <span class="hljs-string">""</span> + userId;
        <span class="hljs-comment">// 创建一个订单对象</span>
        Order order = <span class="hljs-keyword">new</span> Order(orderId, <span class="hljs-keyword">new</span> Date(), cart.getTotalPrice(), <span class="hljs-number">0</span>, userId);
        <span class="hljs-comment">// 保存 订单到数据库</span>
        orderDao.saveOrder(order);
        <span class="hljs-comment">// 保存订单项</span>
        <span class="hljs-comment">// 创建订单项</span>
        <span class="hljs-comment">// 遍历购物车中的每一个商品项转换为订单商品项</span>
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, CartItem&gt; entry : cart.getItems().entrySet()) &#123;
            CartItem cartItem = entry.getValue();
            OrderItem orderItem = <span class="hljs-keyword">new</span> OrderItem(<span class="hljs-keyword">null</span>, cartItem.getName(), cartItem.getCount(), cartItem.getPrice(), cartItem.getTotalPrice(), orderId);
            orderItemDao.saveOrderItem(orderItem);

            <span class="hljs-comment">// 修改图书库存和销量</span>
            <span class="hljs-comment">// 获取book对象</span>
            Book book = bookDao.queryBookById(cartItem.getId());
            book.setSales(book.getSales() + cartItem.getCount());
            book.setStock(book.getStock() - cartItem.getCount());
            bookDao.updateBook(book);
        &#125;
        <span class="hljs-comment">// 清空购物车</span>
        cart.clear();
        <span class="hljs-keyword">return</span> orderId;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">showAllOrder</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderDao.queryOrders();
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        orderDao.changeOrderStatus(orderId,<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OrderItem <span class="hljs-title">showOrderDetailById</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderItemDao.queryOrderItemsByOrderId(orderId);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title">showMyOrder</span><span class="hljs-params">(Integer userId)</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderDao.queryOrderByUserId(userId);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiverOrder</span><span class="hljs-params">(String orderId)</span> </span>&#123;
        orderDao.changeOrderStatus(orderId,<span class="hljs-number">2</span>);
    &#125;
&#125;</code></pre>

<h3 id="5、创建OrderServlet并添加相应的功能"><a href="#5、创建OrderServlet并添加相应的功能" class="headerlink" title="5、创建OrderServlet并添加相应的功能"></a>5、创建OrderServlet并添加相应的功能</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseServlet</span> </span>&#123;

    <span class="hljs-keyword">private</span> OrderService orderService = <span class="hljs-keyword">new</span> OrderServiceImpl();
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 生成订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createOrder</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取Cart对象</span>
        Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
        <span class="hljs-comment">// 获取userId</span>
        User user = (User) req.getSession().getAttribute(<span class="hljs-string">"user"</span>);
        Integer userId = user.getId();
        <span class="hljs-comment">// 调用orderService</span>
        String orderId = orderService.createOrder(cart, userId);
        req.getSession().setAttribute(<span class="hljs-string">"orderId"</span>,orderId);
        <span class="hljs-comment">// 重定向结算成功页面</span>
        resp.sendRedirect(req.getContextPath()+<span class="hljs-string">"/pages/cart/checkout.jsp"</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询我的订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showMyOrders</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取userId</span>
        User user = (User) req.getSession().getAttribute(<span class="hljs-string">"user"</span>);
        Integer userId = user.getId();
        <span class="hljs-comment">// 得到order对象</span>
        List&lt;Order&gt; orders= orderService.showMyOrder(userId);
        <span class="hljs-comment">// 保存至request中</span>
        req.setAttribute(<span class="hljs-string">"orders"</span>,orders);
        <span class="hljs-comment">// 请求转发到我的订单页面</span>
        req.getRequestDispatcher(<span class="hljs-string">"/pages/order/order.jsp"</span>).forward(req,resp);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查看商品详情</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showOrderDetail</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取orderId</span>
        String orderId = req.getParameter(<span class="hljs-string">"orderId"</span>);
        <span class="hljs-comment">// System.out.println(orderId);</span>
        <span class="hljs-comment">// 创建OrderItem对象</span>
        <span class="hljs-comment">// 调用oderService.showOrderDetailById()</span>
        OrderItem orderItem = orderService.showOrderDetailById(orderId);
        req.setAttribute(<span class="hljs-string">"orderItem"</span>,orderItem);
        req.getRequestDispatcher(<span class="hljs-string">"/pages/order/order_detail.jsp"</span>).forward(req,resp);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 显示所有订单</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showAllOrders</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        List&lt;Order&gt; allOrders =  orderService.showAllOrder();
        req.setAttribute(<span class="hljs-string">"allOrders"</span>,allOrders);
        req.getRequestDispatcher(<span class="hljs-string">"/pages/manager/order_manager.jsp"</span>).forward(req,resp);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发货</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取orderId</span>
        String orderId = req.getParameter(<span class="hljs-string">"orderId"</span>);
        orderService.sendOrder(orderId);
        resp.sendRedirect(req.getContextPath()+<span class="hljs-string">"/orderServlet?action=showAllOrders"</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 确认收货</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiverOrder</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
        <span class="hljs-comment">// 获取orderId</span>
        String orderId = req.getParameter(<span class="hljs-string">"orderId"</span>);
        orderService.receiverOrder(orderId);
        resp.sendRedirect(req.getContextPath()+<span class="hljs-string">"/orderServlet?action=showMyOrders"</span>);
    &#125;
&#125;</code></pre>

<h3 id="5、调整jsp页面"><a href="#5、调整jsp页面" class="headerlink" title="5、调整jsp页面"></a>5、调整jsp页面</h3><p>1.修改购物车页面中去结算的跳转地址<img src="/2020/04/08/javaweb-02/45.png" srcset="/img/loading.gif" alt></p>
<p>2.在order.jsp中显示当前用户的订单信息</p>
<pre><code class="hljs jsp">&lt;table&gt;
   &lt;tr&gt;
      &lt;td&gt;日期&lt;/td&gt;
      &lt;td&gt;金额&lt;/td&gt;
      &lt;td&gt;状态&lt;/td&gt;
      &lt;td&gt;详情&lt;/td&gt;
      &lt;td&gt;确认收货&lt;/td&gt;
   &lt;/tr&gt;
   &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;not empty requestScope.orders&#125;"</span>&gt;
      &lt;c:forEach items=<span class="hljs-string">"$&#123;requestScope.orders&#125;"</span> <span class="hljs-keyword">var</span>=<span class="hljs-string">"order"</span>&gt;
         &lt;tr&gt;
            &lt;td&gt;$&#123;order.createTime&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;order.price&#125;&lt;/td&gt;
            &lt;td&gt;
               &lt;c:choose&gt;
                  &lt;c:when test="$&#123;order.status==0&#125;"&gt;未发货&lt;/c:when&gt;
                  &lt;c:when test="$&#123;order.status==1&#125;"&gt;已发货&lt;/c:when&gt;
                  &lt;c:otherwise&gt;已签收&lt;/c:otherwise&gt;
               &lt;/c:choose&gt;
            &lt;/td&gt;
            &lt;td&gt;&lt;a href="orderServlet?action=showOrderDetail&amp;orderId=$&#123;order.orderId&#125;"&gt;查看详情&lt;/a&gt;&lt;/td&gt;
            &lt;td&gt;&lt;c:choose&gt;
               &lt;c:when test="$&#123;order.status==0&#125;"&gt;&lt;span style="color: red"&gt;还没有发货哦~&lt;/span&gt;&lt;/c:when&gt;
               &lt;c:when test="$&#123;order.status==1&#125;"&gt;&lt;a href="orderServlet?action=receiverOrder&amp;orderId=$&#123;order.orderId&#125;"&gt;确认收货&lt;/a&gt;&lt;/c:when&gt;
               &lt;c:otherwise&gt;&lt;span style="color: red"&gt;已经签收了~&lt;/span&gt;&lt;/c:otherwise&gt;
            &lt;/c:choose&gt;
            &lt;/td&gt;
         &lt;/tr&gt;
      &lt;/c:forEach&gt;
   &lt;/c:if&gt;
   &lt;c:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"$&#123;empty requestScope.orders&#125;"</span>&gt;
      &lt;td colspan="4"&gt;&lt;a href="pages/cart/cart.jsp"&gt;您暂时没有订单，快去购物车下单吧~&lt;/a&gt;&lt;/td&gt;
   &lt;/c:if&gt;
&lt;/table&gt;</code></pre>

<p>4.在order_detail.jsp中显示订单的详细信息</p>
<pre><code class="hljs jsp">&lt;table&gt;
    &lt;tr&gt;
        &lt;td&gt;商品名称&lt;/td&gt;
        &lt;td&gt;数量&lt;/td&gt;
        &lt;td&gt;单价&lt;/td&gt;
        &lt;td&gt;总价&lt;/td&gt;
        &lt;td&gt;订单号&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;$&#123;requestScope.orderItem.name&#125;&lt;/td&gt;
        &lt;td&gt;$&#123;requestScope.orderItem.count&#125;&lt;/td&gt;
        &lt;td&gt;$&#123;requestScope.orderItem.price&#125;&lt;/td&gt;
        &lt;td&gt;$&#123;requestScope.orderItem.totalPrice&#125;&lt;/td&gt;
        &lt;td&gt;$&#123;requestScope.orderItem.orderId&#125;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</code></pre>

<p>5.修改首页的后台管理中订单管理的跳转地址<br><img src="/2020/04/08/javaweb-02/46.png" srcset="/img/loading.gif" alt></p>
<p>6.在订单管理中显示所有的订单信息</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>日期<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>金额<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>详情<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>状态<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>发货<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">c:if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;not empty requestScope.allOrders&#125;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">c:forEach</span> <span class="hljs-attr">items</span>=<span class="hljs-string">"$&#123;requestScope.allOrders&#125;"</span> <span class="hljs-attr">var</span>=<span class="hljs-string">"order"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;order.createTime&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;order.price&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"orderServlet?action=showOrderDetail&amp;orderId=$&#123;order.orderId&#125;"</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">c:choose</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;order.status==0&#125;"</span>&gt;</span>未发货<span class="hljs-tag">&lt;/<span class="hljs-name">c:when</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;order.status==1&#125;"</span>&gt;</span>已发货<span class="hljs-tag">&lt;/<span class="hljs-name">c:when</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:otherwise</span>&gt;</span>已签收<span class="hljs-tag">&lt;/<span class="hljs-name">c:otherwise</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">c:choose</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">c:choose</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;order.status==0&#125;"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"orderServlet?action=sendOrder&amp;orderId=$&#123;order.orderId&#125;"</span>&gt;</span>发货<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">c:when</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;order.status==1&#125;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: red"</span>&gt;</span>已经发货了~<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">c:when</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">c:otherwise</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: red"</span>&gt;</span>已经签收了~<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">c:otherwise</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">c:choose</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">c:forEach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">c:if</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">c:if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"$&#123;empty requestScope.allOrders&#125;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"5"</span>&gt;</span>暂时没有订单<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">c:if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></code></pre>

<h2 id="十六、使用Filter实现权限检查"><a href="#十六、使用Filter实现权限检查" class="headerlink" title="十六、使用Filter实现权限检查"></a>十六、使用Filter实现权限检查</h2><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.filter;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManagerFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;

    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;
        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
        User user = (User) httpServletRequest.getSession().getAttribute(<span class="hljs-string">"user"</span>);
        <span class="hljs-keyword">if</span>(user.getStatus()!=<span class="hljs-number">1</span>)&#123;
            httpServletRequest.getRequestDispatcher(<span class="hljs-string">"/pages/user/login.jsp"</span>).forward(request,response);
        &#125;<span class="hljs-keyword">else</span>&#123;
            chain.doFilter(request,response);
        &#125;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;

    &#125;
&#125;</code></pre>

<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>ManagerFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.bookmall.filter.ManagerFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>ManagerFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/pages/manager/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/manager/bookServlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span></code></pre>

<h2 id="十七、使用Filter和TheadLocal组合管理事务"><a href="#十七、使用Filter和TheadLocal组合管理事务" class="headerlink" title="十七、使用Filter和TheadLocal组合管理事务"></a>十七、使用Filter和TheadLocal组合管理事务</h2><p><img src="/2020/04/08/javaweb-02/49.png" srcset="/img/loading.gif" alt></p>
<p><strong>修改JdbcUtils：</strong><br>创建一个ThreadLocal对象，用于将获取的连接与当前线程关联：<br><img src="/2020/04/08/javaweb-02/47.png" srcset="/img/loading.gif" alt><br>修改getConnection()：</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection</span><span class="hljs-params">()</span> </span>&#123;
    Connection conn = conns.get();
    <span class="hljs-keyword">if</span> (conn == <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">try</span> &#123;
            conn = dataSource.getConnection();<span class="hljs-comment">// 从数据库连接池中获取连接</span>
            conns.set(conn);<span class="hljs-comment">// 将连接保存到ThreadLocal对象中，供后面的jdbc操作使用，保证执行事务时是同一个连接</span>
            conn.setAutoCommit(<span class="hljs-keyword">false</span>);<span class="hljs-comment">// 设置为不自动提交事务</span>
        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> conn;
&#125;</code></pre>

<p>添加提交并关闭连接的方法以及回滚并关闭连接的方法：</p>
<pre><code class="hljs java"> <span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 提交事务并关闭连接</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitAndClose</span><span class="hljs-params">()</span></span>&#123;
    Connection conn = conns.get();
    <span class="hljs-keyword">if</span>(conn!=<span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">try</span> &#123;
            conn.commit();<span class="hljs-comment">// 提交事务</span>
        &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;
            throwables.printStackTrace();
        &#125; <span class="hljs-keyword">finally</span> &#123;
            <span class="hljs-keyword">try</span> &#123;
                conn.close();<span class="hljs-comment">// 关闭连接</span>
            &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;
                throwables.printStackTrace();
            &#125;
        &#125;
    &#125;
    <span class="hljs-comment">// 移除线程</span>
    conns.remove(); 
&#125;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 回滚事务并关闭连接</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rollbackAndClose</span><span class="hljs-params">()</span></span>&#123;
    Connection conn = conns.get();
    <span class="hljs-keyword">if</span>(conn !=<span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">try</span> &#123;
            conn.rollback();
        &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;
            throwables.printStackTrace();
        &#125; <span class="hljs-keyword">finally</span> &#123;
            <span class="hljs-keyword">try</span> &#123;
                conn.close();
            &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;
                throwables.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

<p><strong>修改BaseDao,BaseServlet：</strong><br>1、将所有方法中的关闭连接操作删除，用于保证所用操作都使用同一个连接；<br>2、在每个方法中都添加抛出异常的语句，提供给执行相应操作的Servlet程序捕获，用于回滚。<br> <strong>使用Filter过滤器为所用的Service方法添加try-catch:</strong><br><img src="/2020/04/08/javaweb-02/48.png" srcset="/img/loading.gif" alt></p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bookmall.filter;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;

    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            chain.doFilter(request,response);
            <span class="hljs-comment">// 提交事务</span>
            JdbcUtils.commitAndClose();
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            <span class="hljs-comment">// 回滚事务</span>
            JdbcUtils.rollbackAndClose();
            <span class="hljs-comment">// 将异常抛给服务器</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);
        &#125;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;

    &#125;
&#125;</code></pre>

<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>TransactionFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.bookmall.filter.TransactionFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>TransactionFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
    <span class="hljs-comment">&lt;!--  当前工程下的所有请求 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span></code></pre>

<p><strong>将所有异常同一交给Tomcat，让Tomcat展示友好的错误信息页面：</strong><br>配置web.xml</p>
<pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 配置服务器出错后，自动跳转的页面--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">error-page</span>&gt;</span>
    <span class="hljs-comment">&lt;!--   错误类型--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">error-code</span>&gt;</span>404<span class="hljs-tag">&lt;/<span class="hljs-name">error-code</span>&gt;</span>
    <span class="hljs-comment">&lt;!--  要跳转去的页面路径--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/pages/error/error404.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">error-page</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">error-page</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">error-code</span>&gt;</span>500<span class="hljs-tag">&lt;/<span class="hljs-name">error-code</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/pages/error/error500.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">error-page</span>&gt;</span></code></pre>

<h2 id="十八、使用Ajax判断用户名是否可用"><a href="#十八、使用Ajax判断用户名是否可用" class="headerlink" title="十八、使用Ajax判断用户名是否可用"></a>十八、使用Ajax判断用户名是否可用</h2><p><img src="/2020/04/08/javaweb-02/50.jpg" srcset="/img/loading.gif" alt></p>
<pre><code class="hljs javaScript"><span class="hljs-comment">// 给用户名输入框绑定失去焦点事件</span>
$(<span class="hljs-string">"#username"</span>).blur(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-comment">// 获取用户名</span>
    <span class="hljs-keyword">var</span> username = <span class="hljs-keyword">this</span>.value;
    $.getJSON(
        <span class="hljs-string">"$&#123;pageScope.basePath&#125;userServlet"</span>,
        <span class="hljs-string">"action=ajaxExistUsername&amp;username="</span> + username,
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;
            <span class="hljs-keyword">if</span> (data.existUsername) &#123;
                $(<span class="hljs-string">"span.errorMsg"</span>).css(&#123;<span class="hljs-attr">color</span>:<span class="hljs-string">"#dd0000"</span>&#125;);
                $(<span class="hljs-string">"span.errorMsg"</span>).text(<span class="hljs-string">"用户名已存在！"</span>);
            &#125; <span class="hljs-keyword">else</span> &#123;
                $(<span class="hljs-string">"span.errorMsg"</span>).css(&#123;<span class="hljs-attr">color</span>:<span class="hljs-string">"#00dd00"</span>&#125;);
                $(<span class="hljs-string">"span.errorMsg"</span>).text(<span class="hljs-string">"用户名可用~"</span>);
            &#125;
        &#125;);
&#125;);</code></pre>

<p>在UserServlet中添加ajaxExisUsername()</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 验证用户名是否已经注册</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ajaxExistUsername</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException</span>&#123;
    <span class="hljs-comment">// 获取请求参数</span>
    String username = req.getParameter(<span class="hljs-string">"username"</span>);
    <span class="hljs-comment">// 调用userService</span>
    <span class="hljs-keyword">boolean</span> existUsername = userService.existUsername(username);
    <span class="hljs-comment">// 把返回的结果封装成Map对象</span>
    Map&lt;String,Object&gt; resultMap = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();
    resultMap.put(<span class="hljs-string">"existUsername"</span>,existUsername);
    <span class="hljs-comment">// 将Map对象转换为json字符串</span>
    Gson gson = <span class="hljs-keyword">new</span> Gson();
    String json = gson.toJson(resultMap);
    resp.getWriter().write(json);
&#125;</code></pre>

<h2 id="十九、使用Ajax修改把商品添加到购物车"><a href="#十九、使用Ajax修改把商品添加到购物车" class="headerlink" title="十九、使用Ajax修改把商品添加到购物车"></a>十九、使用Ajax修改把商品添加到购物车</h2><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 使用Ajax添加图书到购物车</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> req</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> resp</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> ServletException</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ajaxAddItem</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;
    <span class="hljs-comment">// System.out.println("加入购物车");</span>
    <span class="hljs-comment">// 获取请求参数  商品编号</span>
    <span class="hljs-keyword">int</span> id = WebUtils.parseInt(req.getParameter(<span class="hljs-string">"id"</span>),<span class="hljs-number">0</span>);
    <span class="hljs-comment">// 调用bookService.queryBookById(id) 得到图书信息</span>
    Book book = bookService.queryBookById(id);
    <span class="hljs-comment">// 将图书信息转换为CartItem商品项</span>
    CartItem cartItem = <span class="hljs-keyword">new</span> CartItem(book.getId(),book.getName(),<span class="hljs-number">1</span>,book.getPrice(),book.getPrice());
    <span class="hljs-comment">// 调用cart.add(CartItem)添加至购物车</span>
    Cart cart = (Cart) req.getSession().getAttribute(<span class="hljs-string">"cart"</span>);
    <span class="hljs-keyword">if</span>(cart == <span class="hljs-keyword">null</span>)&#123;
        cart = <span class="hljs-keyword">new</span> Cart();
        req.getSession().setAttribute(<span class="hljs-string">"cart"</span>,cart);
    &#125;
    cart.addItem(cartItem);
    <span class="hljs-comment">// 将添加的商品添加到session域中</span>
    req.getSession().setAttribute(<span class="hljs-string">"itemName"</span>,cartItem.getName());
    <span class="hljs-comment">// 将需要在页面刷新的信息封装到Map中</span>
    Map&lt;String,Object&gt; resultMap = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();
    <span class="hljs-comment">// 购物车中总的商品数量</span>
    resultMap.put(<span class="hljs-string">"totalCount"</span>,cart.getTotalCount());
    <span class="hljs-comment">// 最后一个添加到购物车的商品名称</span>
    resultMap.put(<span class="hljs-string">"lastName"</span>,cartItem.getName());
    <span class="hljs-comment">// 将Map转换为json字符串</span>
    Gson gson = <span class="hljs-keyword">new</span> Gson();
    String json = gson.toJson(resultMap);
    <span class="hljs-comment">// 回传给客户端</span>
    resp.getWriter().write(json);
&#125;</code></pre>

<pre><code class="hljs javaScript"><span class="hljs-keyword">var</span> bookid = $(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">"bookid"</span>);<span class="hljs-comment">// 获取选中元素的属性值</span>
<span class="hljs-comment">// location.href="$&#123;pageScope.basePath&#125;cartServlet?action=addItem&amp;id="+bookid;</span>
<span class="hljs-comment">// 使用ajax发送请求</span>
$.getJSON(
    <span class="hljs-string">"$&#123;pageScope.basePath&#125;cartServlet"</span>,
    <span class="hljs-string">"action=ajaxAddItem&amp;id="</span> + bookid,
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;
        $(<span class="hljs-string">"#cartTotalCount"</span>).text(data.totalCount);
        $(<span class="hljs-string">"#cartlastName"</span>).text(data.lastName);
    &#125;)</code></pre>

<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>您的购物车中有<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cartTotalCount"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color:red"</span>&gt;</span>$&#123;sessionScope.cart.totalCount&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>件商品<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
    您刚刚将<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cartlastName"</span><span class="hljs-attr">style</span>=<span class="hljs-string">"color:red"</span>&gt;</span>$&#123;sessionScope.itemName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>加入到了购物车中
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></code></pre>
            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/JavaWeb%E9%A1%B9%E7%9B%AE/">JavaWeb项目</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/04/11/javaweb-03/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">jsp,Listener监听器</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/04/05/javaweb-01/">
                        <span class="hidden-mobile">Servlet</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-md">
    <div class="container custom post-content mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "书城项目&nbsp;",
      ],
      cursorChar: "(*＾_＾*)",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //定义获取词语下标
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //点击body时触发事件
        $("body").click(function (e) {
          //需要显示的词语
          var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正", "法治", "爱国", "敬业", "诚信", "友善");
          //设置词语给span标签
          var $i = $("<span/>").text(a[a_idx]);
          //下标等于原来下标+1  余 词语总数
          a_idx = (a_idx + 1) % a.length;
          //获取鼠标指针的位置，分别相对于文档的左和右边缘。
          //获取x和y的指针坐标
          var x = e.pageX, y = e.pageY;
          //在鼠标的指针的位置给$i定义的span标签添加css样式
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // 随机颜色
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //在body添加这个标签
          $("body").append($i);
          //animate() 方法执行 CSS 属性集的自定义动画。
          //该方法通过CSS样式将元素从一个状态改变为另一个状态。CSS属性值是逐渐改变的，这样就可以创建动画效果。
          //详情请看http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //将原来的位置向上移动180
            "top": y - 180,
            "opacity": 0
            //1500动画的速度
          }, 1500, function () {
            //时间到了自动删除
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
